<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BuilderCommonMemberFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Providence Generator : Java</a> &gt; <a href="index.source.html" class="el_package">net.morimekta.providence.generator.format.java.messages</a> &gt; <span class="el_source">BuilderCommonMemberFormatter.java</span></div><h1>BuilderCommonMemberFormatter.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016 Providence Authors
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package net.morimekta.providence.generator.format.java.messages;

import net.morimekta.providence.PType;
import net.morimekta.providence.descriptor.PContainer;
import net.morimekta.providence.descriptor.PMap;
import net.morimekta.providence.descriptor.PPrimitive;
import net.morimekta.providence.generator.GeneratorException;
import net.morimekta.providence.generator.format.java.shared.MessageMemberFormatter;
import net.morimekta.providence.generator.format.java.utils.BlockCommentBuilder;
import net.morimekta.providence.generator.format.java.utils.JAnnotation;
import net.morimekta.providence.generator.format.java.utils.JField;
import net.morimekta.providence.generator.format.java.utils.JHelper;
import net.morimekta.providence.generator.format.java.utils.JMessage;
import net.morimekta.util.io.IndentedPrintWriter;

import java.util.BitSet;
import java.util.Collection;
import java.util.Objects;

import static net.morimekta.providence.generator.format.java.messages.CoreOverridesFormatter.UNION_FIELD;
import static net.morimekta.util.Strings.camelCase;

/**
 * @author Stein Eldar Johnsen
 * @since 08.01.16.
 */
public class BuilderCommonMemberFormatter implements MessageMemberFormatter {
    protected final IndentedPrintWriter        writer;
    protected final JHelper                    helper;

    public BuilderCommonMemberFormatter(IndentedPrintWriter writer,
<span class="fc" id="L52">                                        JHelper helper) {</span>
<span class="fc" id="L53">        this.writer = writer;</span>
<span class="fc" id="L54">        this.helper = helper;</span>
<span class="fc" id="L55">    }</span>

    @Override
    public void appendClassAnnotations(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(message.descriptor())) {</span>
<span class="nc" id="L60">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }
<span class="fc" id="L62">    }</span>

    @Override
    public void appendConstructors(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L66">        appendDefaultConstructor(message);</span>
<span class="fc" id="L67">        appendMutateConstructor(message);</span>
<span class="fc" id="L68">    }</span>

    @Override
    public void appendFields(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L73">            appendUnionFields(message);</span>
        } else {
<span class="fc" id="L75">            appendStructFields(message);</span>
        }
<span class="fc" id="L77">        appendModifiedFields(message);</span>

<span class="fc bfc" id="L79" title="All 2 branches covered.">        for (JField field : message.declaredOrderFields()) {</span>
            // Void fields have no value.
<span class="fc bfc" id="L81" title="All 2 branches covered.">            if (field.isVoid()) {</span>
<span class="fc" id="L82">                continue;</span>
            }
<span class="fc" id="L84">            writer.formatln(&quot;private %s %s;&quot;, field.builderFieldType(), field.member());</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">            if (field.type() == PType.MESSAGE) {</span>
<span class="fc" id="L86">                writer.formatln(&quot;private %s._Builder %s_builder;&quot;, field.builderFieldType(), field.member());</span>
            }
<span class="fc" id="L88">        }</span>
<span class="fc" id="L89">        if (message.declaredOrderFields()</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">                   .size() &gt; 0) {</span>
<span class="fc" id="L91">            writer.newline();</span>
        }
<span class="fc" id="L93">    }</span>

    @Override
    public void appendMethods(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc bfc" id="L97" title="All 2 branches covered.">        for (JField field : message.declaredOrderFields()) {</span>
<span class="fc" id="L98">            appendSetter(message, field);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">            if (field.container()) {</span>
<span class="fc" id="L100">                appendAdder(message, field);</span>
            }
<span class="fc" id="L102">            appendIsSet(message, field);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">            if( !message.isUnion() ) {</span>
<span class="fc" id="L104">                appendIsModified(message, field);</span>
            }
<span class="fc" id="L106">            appendResetter(message, field);</span>
<span class="fc" id="L107">            appendMutableGetters(message, field);</span>
<span class="fc" id="L108">        }</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if( message.isUnion() ) {</span>
<span class="fc" id="L110">            appendIsModified(message);</span>
        }
<span class="fc" id="L112">        appendEquals(message);</span>
<span class="fc" id="L113">        appendHashCode(message);</span>
<span class="fc" id="L114">    }</span>

    @Override
    public void appendExtraProperties(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L118">        appendBuilderBuild(message);</span>
<span class="fc" id="L119">    }</span>

    private void appendBuilderBuild(JMessage&lt;?&gt; message) {
<span class="fc" id="L122">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L123">              .formatln(&quot;public %s build() {&quot;, message.instanceType())</span>
<span class="fc" id="L124">              .begin()</span>
<span class="fc" id="L125">              .formatln(&quot;return new %s(this);&quot;, message.instanceType())</span>
<span class="fc" id="L126">              .end()</span>
<span class="fc" id="L127">              .appendln('}');</span>
<span class="fc" id="L128">    }</span>

    private void appendEquals(JMessage&lt;?&gt; message) {
<span class="fc" id="L131">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L132">              .appendln(&quot;public boolean equals(Object o) {&quot;)</span>
<span class="fc" id="L133">              .begin()</span>
<span class="fc" id="L134">              .appendln(&quot;if (o == this) return true;&quot;)</span>
<span class="fc" id="L135">              .appendln(&quot;if (o == null || !o.getClass().equals(getClass())) return false;&quot;);</span>
<span class="fc" id="L136">        if (message.numericalOrderFields()</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">                   .size() &gt; 0) {</span>
<span class="fc" id="L138">            writer.formatln(&quot;%s._Builder other = (%s._Builder) o;&quot;, message.instanceType(), message.instanceType())</span>
<span class="fc" id="L139">                  .appendln(&quot;return &quot;);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">            if (message.isUnion()) {</span>
<span class="fc" id="L141">                writer.format(&quot;%s.equals(%s, other.%s)&quot;,</span>
<span class="fc" id="L142">                              Objects.class.getName(),</span>
                              UNION_FIELD,
                              UNION_FIELD);
            } else {
<span class="fc" id="L146">                writer.format(&quot;%s.equals(optionals, other.optionals)&quot;,</span>
<span class="fc" id="L147">                              Objects.class.getName());</span>
            }

<span class="fc bfc" id="L150" title="All 2 branches covered.">            for (JField field : message.declaredOrderFields()) {</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">                if (field.isVoid()) continue;</span>

<span class="fc" id="L153">                writer.append(&quot; &amp;&amp;&quot;)</span>
<span class="fc" id="L154">                      .appendln(&quot;       &quot;);</span>
<span class="fc" id="L155">                writer.format(&quot;%s.equals(%s, other.%s)&quot;,</span>
<span class="fc" id="L156">                              Objects.class.getName(),</span>
<span class="fc" id="L157">                              field.member(), field.member());</span>
<span class="fc" id="L158">            }</span>
<span class="fc" id="L159">            writer.append(';');</span>
        } else {
<span class="fc" id="L161">            writer.appendln(&quot;return true;&quot;);</span>
        }
<span class="fc" id="L163">        writer.end()</span>
<span class="fc" id="L164">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L165">              .newline();</span>
<span class="fc" id="L166">    }</span>

    private void appendHashCode(JMessage&lt;?&gt; message) {
<span class="fc" id="L169">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L170">              .appendln(&quot;public int hashCode() {&quot;)</span>
<span class="fc" id="L171">              .begin()</span>
<span class="fc" id="L172">              .formatln(&quot;return %s.hash(&quot;,</span>
<span class="fc" id="L173">                        Objects.class.getName())</span>
<span class="fc" id="L174">              .begin(&quot;        &quot;)</span>
<span class="fc" id="L175">              .formatln(&quot;%s.class&quot;, message.instanceType());</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">        if (!message.isUnion()) {</span>
<span class="fc" id="L177">            writer.append(&quot;, optionals&quot;);</span>
        }
<span class="fc" id="L179">        message.numericalOrderFields()</span>
<span class="fc" id="L180">               .stream()</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">               .filter(field -&gt; !field.isVoid())</span>
<span class="fc" id="L182">               .forEach(field -&gt; {</span>
<span class="fc" id="L183">                   writer.append(&quot;,&quot;);</span>
<span class="fc" id="L184">                   writer.formatln(&quot;_Field.%s, %s&quot;, field.fieldEnum(), field.member());</span>
<span class="fc" id="L185">               });</span>

<span class="fc" id="L187">        writer.end()</span>
<span class="fc" id="L188">              .append(&quot;);&quot;)</span>
<span class="fc" id="L189">              .end()</span>
<span class="fc" id="L190">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L191">              .newline();</span>
<span class="fc" id="L192">    }</span>

    private void appendUnionFields(JMessage&lt;?&gt; message) {
<span class="fc" id="L195">        writer.formatln(&quot;private _Field %s;&quot;, UNION_FIELD)</span>
<span class="fc" id="L196">              .newline();</span>
<span class="fc" id="L197">    }</span>

    private void appendStructFields(JMessage&lt;?&gt; message) {
<span class="fc" id="L200">        writer.formatln(&quot;private %s optionals;&quot;,</span>
<span class="fc" id="L201">                        BitSet.class.getName());</span>
<span class="fc" id="L202">    }</span>

    private void appendModifiedFields(JMessage&lt;?&gt; message) {
<span class="fc bfc" id="L205" title="All 2 branches covered.">        if (!message.isUnion()) {</span>
<span class="fc" id="L206">            writer.formatln(&quot;private %s modified;&quot;, BitSet.class.getName())</span>
<span class="fc" id="L207">                  .newline();</span>
        } else {
<span class="fc" id="L209">            writer.formatln(&quot;private %s modified;&quot;, boolean.class.getName())</span>
<span class="fc" id="L210">                  .newline();</span>
        }
<span class="fc" id="L212">    }</span>

    private void appendDefaultConstructor(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L215">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc" id="L216">        comment.comment(&quot;Make a &quot; + message.descriptor().getQualifiedName() + &quot; builder.&quot;)</span>
<span class="fc" id="L217">               .finish();</span>
<span class="fc" id="L218">        writer.appendln(&quot;public _Builder() {&quot;)</span>
<span class="fc" id="L219">              .begin();</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">        if (!message.isUnion()) {</span>
<span class="fc" id="L221">            writer.formatln(&quot;optionals = new %s(%d);&quot;,</span>
<span class="fc" id="L222">                            BitSet.class.getName(),</span>
<span class="fc" id="L223">                            message.declaredOrderFields()</span>
<span class="fc" id="L224">                                   .size());</span>
<span class="fc" id="L225">            writer.formatln(&quot;modified = new %s(%d);&quot;,</span>
<span class="fc" id="L226">                            BitSet.class.getName(),</span>
<span class="fc" id="L227">                            message.declaredOrderFields()</span>
<span class="fc" id="L228">                                   .size());</span>
        } else {
<span class="fc" id="L230">            writer.appendln(&quot;modified = false;&quot;);</span>
        }

<span class="fc bfc" id="L233" title="All 2 branches covered.">        for (JField field : message.declaredOrderFields()) {</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">            if (field.container()) {</span>
<span class="fc" id="L235">                writer.formatln(&quot;%s = new %s&lt;&gt;();&quot;, field.member(), field.builderInstanceType());</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">            } else if (field.alwaysPresent()) {</span>
<span class="fc" id="L237">                writer.formatln(&quot;%s = %s;&quot;, field.member(), field.kDefault());</span>
            }
<span class="fc" id="L239">        }</span>
<span class="fc" id="L240">        writer.end()</span>
<span class="fc" id="L241">              .appendln('}')</span>
<span class="fc" id="L242">              .newline();</span>
<span class="fc" id="L243">    }</span>

    private void appendMutateConstructor(JMessage&lt;?&gt; message) {
<span class="fc" id="L246">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc" id="L247">        comment.comment(&quot;Make a mutating builder off a base &quot; + message.descriptor().getQualifiedName() + &quot;.&quot;)</span>
<span class="fc" id="L248">               .newline()</span>
<span class="fc" id="L249">               .param_(&quot;base&quot;, &quot;The base &quot; + message.descriptor().getName())</span>
<span class="fc" id="L250">               .finish();</span>
<span class="fc" id="L251">        writer.formatln(&quot;public _Builder(%s base) {&quot;, message.instanceType())</span>
<span class="fc" id="L252">              .begin()</span>
<span class="fc" id="L253">              .appendln(&quot;this();&quot;)</span>
<span class="fc" id="L254">              .newline();</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L256">            writer.formatln(&quot;%s = base.%s;&quot;, UNION_FIELD, UNION_FIELD)</span>
<span class="fc" id="L257">                  .newline();</span>
        }
<span class="fc bfc" id="L259" title="All 2 branches covered.">        for (JField field : message.declaredOrderFields()) {</span>
<span class="fc bfc" id="L260" title="All 4 branches covered.">            boolean checkPresence = message.isUnion() ? field.container() : !field.alwaysPresent();</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">            if (checkPresence) {</span>
<span class="fc" id="L262">                writer.formatln(&quot;if (base.%s()) {&quot;, field.presence())</span>
<span class="fc" id="L263">                      .begin();</span>
            }
<span class="fc bfc" id="L265" title="All 2 branches covered.">            if (!message.isUnion()) {</span>
<span class="fc" id="L266">                writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
            }
<span class="pc bfc" id="L268" title="All 4 branches covered.">            switch (field.type()) {</span>
                case VOID:
                    // Void fields have no value.
<span class="fc" id="L271">                    break;</span>
                case LIST:
                case SET:
<span class="fc" id="L274">                    writer.formatln(&quot;%s.addAll(base.%s);&quot;, field.member(), field.member());</span>
<span class="fc" id="L275">                    break;</span>
                case MAP:
<span class="fc" id="L277">                    writer.formatln(&quot;%s.putAll(base.%s);&quot;, field.member(), field.member());</span>
<span class="fc" id="L278">                    break;</span>
                default:
<span class="fc" id="L280">                    writer.formatln(&quot;%s = base.%s;&quot;, field.member(), field.member());</span>
                    break;
            }
<span class="fc bfc" id="L283" title="All 2 branches covered.">            if (checkPresence) {</span>
<span class="fc" id="L284">                writer.end()</span>
<span class="fc" id="L285">                      .appendln('}');</span>
            }
<span class="fc" id="L287">        }</span>

<span class="fc" id="L289">        writer.end()</span>
<span class="fc" id="L290">              .appendln('}')</span>
<span class="fc" id="L291">              .newline();</span>
<span class="fc" id="L292">    }</span>

    private void appendSetter(JMessage message, JField field) throws GeneratorException {
<span class="fc" id="L295">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L297">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L299">            comment.comment(&quot;Sets the value of &quot; + field.name() + &quot;.&quot;);</span>
        }
<span class="fc" id="L301">        comment.newline();</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">        if (!field.isVoid()) {</span>
<span class="fc" id="L303">            comment.param_(&quot;value&quot;, &quot;The new value&quot;);</span>
        }
<span class="fc" id="L305">        comment.return_(&quot;The builder&quot;)</span>
<span class="fc" id="L306">               .finish();</span>
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(field)) {</span>
<span class="nc" id="L308">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }
<span class="fc" id="L310">        writer.appendln(JAnnotation.NON_NULL);</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">        if (field.isVoid()) {</span>
            // Void fields have no value.
<span class="fc" id="L313">            writer.formatln(&quot;public _Builder %s() {&quot;, field.setter());</span>
<span class="fc bfc" id="L314" title="All 4 branches covered.">        } else if (field.type() == PType.SET || field.type() == PType.LIST) {</span>
<span class="fc" id="L315">            PContainer&lt;?&gt; cType = (PContainer&lt;?&gt;) field.field()</span>
<span class="fc" id="L316">                                                       .getDescriptor();</span>
<span class="fc" id="L317">            String iType = helper.getFieldType(cType.itemDescriptor());</span>
<span class="fc" id="L318">            writer.formatln(&quot;public _Builder %s(%s&lt;%s&gt; value) {&quot;,</span>
<span class="fc" id="L319">                            field.setter(), Collection.class.getName(), iType);</span>
<span class="fc" id="L320">        } else {</span>
<span class="fc" id="L321">            writer.formatln(&quot;public _Builder %s(%s value) {&quot;, field.setter(), field.valueType());</span>
        }
<span class="fc" id="L323">        writer.begin();</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">        if (!field.isPrimitiveJavaValue()) {</span>
<span class="fc" id="L325">            writer.formatln(&quot;if (value == null) {&quot;)</span>
<span class="fc" id="L326">                  .formatln(&quot;    return %s();&quot;, field.resetter())</span>
<span class="fc" id="L327">                  .appendln('}')</span>
<span class="fc" id="L328">                  .newline();</span>
        }

<span class="fc bfc" id="L331" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L332">            writer.formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L333">            writer.appendln(&quot;modified = true;&quot;);</span>
        } else {
<span class="fc" id="L335">            writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L336">            writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
        }

<span class="fc bfc" id="L339" title="All 5 branches covered.">        switch (field.type()) {</span>
            case VOID:
                // Void fields have no value.
<span class="fc" id="L342">                break;</span>
            case SET:
            case LIST:
<span class="fc" id="L345">                writer.formatln(&quot;%s.clear();&quot;, field.member())</span>
<span class="fc" id="L346">                      .formatln(&quot;%s.addAll(value);&quot;, field.member());</span>
<span class="fc" id="L347">                break;</span>
            case MAP:
<span class="fc" id="L349">                writer.formatln(&quot;%s.clear();&quot;, field.member())</span>
<span class="fc" id="L350">                      .formatln(&quot;%s.putAll(value);&quot;, field.member());</span>
<span class="fc" id="L351">                break;</span>
            case MESSAGE:
<span class="fc" id="L353">                writer.formatln(&quot;%s_builder = null;&quot;, field.member());</span>
                // intentional overrun.
            default:
<span class="fc" id="L356">                writer.formatln(&quot;%s = value;&quot;, field.member());</span>
                break;
        }

<span class="fc" id="L360">        writer.appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L361">              .end()</span>
<span class="fc" id="L362">              .appendln('}')</span>
<span class="fc" id="L363">              .newline();</span>
<span class="fc" id="L364">    }</span>

    private void appendAdder(JMessage message, JField field) throws GeneratorException {
<span class="fc" id="L367">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>

<span class="fc bfc" id="L369" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L370">            comment.comment(field.comment());</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">        } else if (field.type() == PType.MAP) {</span>
<span class="fc" id="L372">            comment.comment(&quot;Adds a mapping to &quot; + field.name() + &quot;.&quot;);</span>
        } else {
<span class="fc" id="L374">            comment.comment(&quot;Adds entries to &quot; + field.name() + &quot;.&quot;);</span>
        }
<span class="fc" id="L376">        comment.newline();</span>

<span class="fc bfc" id="L378" title="All 2 branches covered.">        if (field.type() == PType.MAP) {</span>
<span class="fc" id="L379">            comment.param_(&quot;key&quot;, &quot;The inserted key&quot;)</span>
<span class="fc" id="L380">                   .param_(&quot;value&quot;, &quot;The inserted value&quot;);</span>
        } else {
<span class="fc" id="L382">            comment.param_(&quot;values&quot;, &quot;The added value&quot;);</span>
        }
<span class="fc" id="L384">        comment.return_(&quot;The builder&quot;)</span>
<span class="fc" id="L385">               .finish();</span>

<span class="pc bpc" id="L387" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(field)) {</span>
<span class="nc" id="L388">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }
<span class="fc" id="L390">        writer.appendln(JAnnotation.NON_NULL);</span>

<span class="pc bpc" id="L392" title="1 of 3 branches missed.">        switch (field.type()) {</span>
            case MAP: {
<span class="fc" id="L394">                PMap&lt;?, ?&gt; mType = (PMap&lt;?, ?&gt;) field.field()</span>
<span class="fc" id="L395">                                                     .getDescriptor();</span>
<span class="fc" id="L396">                String mkType = helper.getValueType(mType.keyDescriptor());</span>
<span class="fc" id="L397">                String miType = helper.getValueType(mType.itemDescriptor());</span>

<span class="fc" id="L399">                writer.formatln(&quot;public _Builder %s(%s key, %s value) {&quot;, field.adder(), mkType, miType)</span>
<span class="fc" id="L400">                      .begin();</span>
<span class="fc bfc" id="L401" title="All 2 branches covered.">                if (message.isUnion()) {</span>
<span class="fc" id="L402">                    writer.formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L403">                    writer.appendln(&quot;modified = true;&quot;);</span>
                } else {
<span class="fc" id="L405">                    writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L406">                    writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
                }
<span class="fc" id="L408">                writer.formatln(&quot;%s.put(key, value);&quot;, field.member())</span>
<span class="fc" id="L409">                      .appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L410">                      .end()</span>
<span class="fc" id="L411">                      .appendln('}')</span>
<span class="fc" id="L412">                      .newline();</span>

<span class="fc" id="L414">                break;</span>
            }
            case SET:
            case LIST: {
<span class="fc" id="L418">                PContainer&lt;?&gt; lType = (PContainer&lt;?&gt;) field.field()</span>
<span class="fc" id="L419">                                                                 .getDescriptor();</span>
<span class="fc" id="L420">                String liType = helper.getValueType(lType.itemDescriptor());</span>

<span class="fc" id="L422">                writer.formatln(&quot;public _Builder %s(%s... values) {&quot;, field.adder(), liType)</span>
<span class="fc" id="L423">                      .begin();</span>
<span class="fc bfc" id="L424" title="All 2 branches covered.">                if (message.isUnion()) {</span>
<span class="fc" id="L425">                    writer.formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L426">                    writer.appendln(&quot;modified = true;&quot;);</span>
                } else {
<span class="fc" id="L428">                    writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L429">                    writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
                }
<span class="fc" id="L431">                writer.formatln(&quot;for (%s item : values) {&quot;, liType)</span>
<span class="fc" id="L432">                      .begin()</span>
<span class="fc" id="L433">                      .formatln(&quot;%s.add(item);&quot;, field.member())</span>
<span class="fc" id="L434">                      .end()</span>
<span class="fc" id="L435">                      .appendln('}')</span>
<span class="fc" id="L436">                      .appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L437">                      .end()</span>
<span class="fc" id="L438">                      .appendln('}')</span>
<span class="fc" id="L439">                      .newline();</span>

<span class="fc" id="L441">                break;</span>
            }
        }
<span class="fc" id="L444">    }</span>

    private void appendIsSet(JMessage message, JField field) {
<span class="fc" id="L447">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L448" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L449">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L451">            comment.comment(&quot;Checks for presence of the &quot; + field.name() + &quot; field.&quot;);</span>
        }

<span class="fc" id="L454">        comment.newline()</span>
<span class="fc" id="L455">               .return_(String.format(&quot;True if %s has been set.&quot;, field.name()))</span>
<span class="fc" id="L456">               .finish();</span>
<span class="fc" id="L457">        writer.formatln(&quot;public boolean %s() {&quot;, field.isSet())</span>
<span class="fc" id="L458">              .begin();</span>

<span class="fc bfc" id="L460" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L461">            writer.formatln(&quot;return %s == _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
        } else {
<span class="fc" id="L463">            writer.formatln(&quot;return optionals.get(%d);&quot;, field.index());</span>
        }
<span class="fc" id="L465">        writer.end()</span>
<span class="fc" id="L466">              .appendln('}')</span>
<span class="fc" id="L467">              .newline();</span>
<span class="fc" id="L468">    }</span>

    private void appendIsModified(JMessage message, JField field) {
<span class="fc" id="L471">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L472" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L473">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L475">            comment.comment(&quot;Checks if &quot; + field.name() + &quot; has been modified since the _Builder was created.&quot;);</span>
        }

<span class="fc" id="L478">        comment.newline()</span>
<span class="fc" id="L479">               .return_(String.format(&quot;True if %s has been modified.&quot;, field.name()))</span>
<span class="fc" id="L480">               .finish();</span>
<span class="fc" id="L481">        writer.formatln(&quot;public boolean %s() {&quot;, field.isModified())</span>
<span class="fc" id="L482">              .begin();</span>
<span class="fc" id="L483">        writer.formatln(&quot;return modified.get(%d);&quot;, field.index());</span>
<span class="fc" id="L484">        writer.end()</span>
<span class="fc" id="L485">              .appendln('}')</span>
<span class="fc" id="L486">              .newline();</span>
<span class="fc" id="L487">    }</span>

    private void appendIsModified(JMessage message) {
<span class="fc" id="L490">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc" id="L491">        comment.comment(&quot;Checks if &quot; + message.descriptor().getName() + &quot; has been modified since the _Builder &quot; +</span>
                        &quot;was created.&quot;);

<span class="fc" id="L494">        comment.newline()</span>
<span class="fc" id="L495">               .return_(String.format(&quot;True if %s has been modified.&quot;, message.descriptor().getName()))</span>
<span class="fc" id="L496">               .finish();</span>
<span class="fc" id="L497">        writer.formatln(&quot;public boolean %s() {&quot;, &quot;isUnionModified&quot;)</span>
<span class="fc" id="L498">              .begin();</span>
<span class="fc" id="L499">        writer.appendln(&quot;return modified;&quot;);</span>
<span class="fc" id="L500">        writer.end()</span>
<span class="fc" id="L501">              .appendln('}')</span>
<span class="fc" id="L502">              .newline();</span>
<span class="fc" id="L503">    }</span>

    private void appendResetter(JMessage message, JField field) {
<span class="fc" id="L506">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L507" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L508">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L510">            comment.comment(&quot;Clears the &quot; + field.name() + &quot; field.&quot;);</span>
        }
<span class="fc" id="L512">        comment.newline()</span>
<span class="fc" id="L513">               .return_(&quot;The builder&quot;)</span>
<span class="fc" id="L514">               .finish();</span>
<span class="fc" id="L515">        writer.appendln(JAnnotation.NON_NULL);</span>
<span class="fc" id="L516">        writer.formatln(&quot;public _Builder %s() {&quot;, field.resetter())</span>
<span class="fc" id="L517">              .begin();</span>

<span class="fc bfc" id="L519" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L520">            writer.formatln(&quot;if (%s == _Field.%s) %s = null;&quot;, UNION_FIELD, field.fieldEnum(), UNION_FIELD);</span>
<span class="fc" id="L521">            writer.appendln(&quot;modified = true;&quot;);</span>
        } else {
<span class="fc" id="L523">            writer.formatln(&quot;optionals.clear(%d);&quot;, field.index());</span>
<span class="fc" id="L524">            writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
        }

<span class="fc bfc" id="L527" title="All 2 branches covered.">        if (field.container()) {</span>
<span class="fc" id="L528">            writer.formatln(&quot;%s.clear();&quot;, field.member());</span>
<span class="fc bfc" id="L529" title="All 2 branches covered.">        } else if (field.isVoid()) {</span>
            // Void fields have no value.
<span class="fc bfc" id="L531" title="All 2 branches covered.">        } else if (field.alwaysPresent()) {</span>
<span class="fc" id="L532">            writer.formatln(&quot;%s = %s;&quot;, field.member(), field.kDefault());</span>
        } else {
<span class="fc" id="L534">            writer.formatln(&quot;%s = null;&quot;, field.member());</span>
<span class="fc bfc" id="L535" title="All 2 branches covered.">            if (field.type() == PType.MESSAGE) {</span>
<span class="fc" id="L536">                writer.formatln(&quot;%s_builder = null;&quot;, field.member());</span>
            }
        }

<span class="fc" id="L540">        writer.appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L541">              .end()</span>
<span class="fc" id="L542">              .appendln('}')</span>
<span class="fc" id="L543">              .newline();</span>
<span class="fc" id="L544">    }</span>

    /**
     * Get mutable values. This returns message builders for messages, collection
     * builders for collections, and the normal immutable value for everything
     * else.
     *
     * @param message The message to get mutable getters for.
     * @param field The field to generate getter for.
     */
    private void appendMutableGetters(JMessage message, JField field) throws GeneratorException {
<span class="fc bfc" id="L555" title="All 2 branches covered.">        if (field.field().getDescriptor() instanceof PPrimitive ||</span>
<span class="fc bfc" id="L556" title="All 2 branches covered.">            field.type() == PType.ENUM) {</span>
            // The other fields will have ordinary non-mutable getters.
<span class="fc" id="L558">            appendGetter(field);</span>
<span class="fc" id="L559">            return;</span>
        }

<span class="fc" id="L562">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L563" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L564">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L566">            comment.comment(&quot;Gets the builder for the contained &quot; + field.name() + &quot;.&quot;);</span>
        }
<span class="fc" id="L568">        comment.newline()</span>
<span class="fc" id="L569">               .return_(&quot;The field builder&quot;)</span>
<span class="fc" id="L570">               .finish();</span>
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(field)) {</span>
<span class="nc" id="L572">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }
<span class="pc bpc" id="L574" title="1 of 3 branches missed.">        switch (field.type()) {</span>
            case MESSAGE: {
<span class="fc" id="L576">                writer.formatln(&quot;public %s._Builder %s() {&quot;, field.instanceType(),</span>
<span class="fc" id="L577">                                camelCase(&quot;mutable&quot;, field.name()))</span>
<span class="fc" id="L578">                      .begin();</span>

<span class="fc bfc" id="L580" title="All 2 branches covered.">                if (message.isUnion()) {</span>
<span class="fc" id="L581">                    writer.formatln(&quot;if (%s != _Field.%s) {&quot;, UNION_FIELD, field.fieldEnum())</span>
<span class="fc" id="L582">                          .formatln(&quot;    %s();&quot;, field.resetter())</span>
<span class="fc" id="L583">                          .appendln('}')</span>
<span class="fc" id="L584">                          .formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L585">                    writer.appendln(&quot;modified = true;&quot;);</span>
                } else {
<span class="fc" id="L587">                    writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L588">                    writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
                }

<span class="fc" id="L591">                writer.newline()</span>
<span class="fc" id="L592">                      .formatln(&quot;if (%s != null) {&quot;, field.member())</span>
<span class="fc" id="L593">                      .formatln(&quot;    %s_builder = %s.mutate();&quot;, field.member(), field.member())</span>
<span class="fc" id="L594">                      .formatln(&quot;    %s = null;&quot;, field.member())</span>
<span class="fc" id="L595">                      .formatln(&quot;} else if (%s_builder == null) {&quot;, field.member())</span>
<span class="fc" id="L596">                      .formatln(&quot;    %s_builder = %s.builder();&quot;, field.member(), field.instanceType())</span>
<span class="fc" id="L597">                      .appendln('}')</span>
<span class="fc" id="L598">                      .formatln(&quot;return %s_builder;&quot;, field.member());</span>

<span class="fc" id="L600">                writer.end()</span>
<span class="fc" id="L601">                      .appendln('}')</span>
<span class="fc" id="L602">                      .newline();</span>
<span class="fc" id="L603">                break;</span>
            }
            case SET:
            case LIST:
            case MAP:
<span class="fc" id="L608">                writer.formatln(&quot;public %s %s() {&quot;, field.builderFieldType(),</span>
<span class="fc" id="L609">                                camelCase(&quot;mutable&quot;, field.name()))</span>
<span class="fc" id="L610">                      .begin();</span>

<span class="fc bfc" id="L612" title="All 2 branches covered.">                if (message.isUnion()) {</span>
<span class="fc" id="L613">                    writer.formatln(&quot;if (%s != _Field.%s) {&quot;, UNION_FIELD, field.fieldEnum())</span>
<span class="fc" id="L614">                          .formatln(&quot;    %s();&quot;, field.resetter())</span>
<span class="fc" id="L615">                          .appendln('}')</span>
<span class="fc" id="L616">                          .formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L617">                    writer.appendln(&quot;modified = true;&quot;);</span>
                } else {
<span class="fc" id="L619">                    writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L620">                    writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
                }

<span class="fc" id="L623">                writer.formatln(&quot;return %s;&quot;, field.member());</span>

<span class="fc" id="L625">                writer.end()</span>
<span class="fc" id="L626">                      .appendln('}')</span>
<span class="fc" id="L627">                      .newline();</span>
<span class="fc" id="L628">                break;</span>
            default:
<span class="nc" id="L630">                throw new GeneratorException(&quot;Unexpected field type: &quot; + field.type());</span>
        }
<span class="fc" id="L632">    }</span>

    private void appendGetter(JField field) {
<span class="fc bfc" id="L635" title="All 2 branches covered.">        if (field.isVoid()) {</span>
<span class="fc" id="L636">            return;</span>
        }

<span class="fc" id="L639">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="pc bpc" id="L640" title="1 of 2 branches missed.">        if (field.hasComment()) {</span>
<span class="nc" id="L641">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L643">            comment.comment(&quot;Gets the value of the contained &quot; + field.name() + &quot;.&quot;);</span>
        }
<span class="fc" id="L645">        comment.newline()</span>
<span class="fc" id="L646">               .return_(&quot;The field value&quot;)</span>
<span class="fc" id="L647">               .finish();</span>
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(field)) {</span>
<span class="nc" id="L649">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }

        // Builder getters are *always* get*, never is* (e.g. for bool)
<span class="fc" id="L653">        writer.formatln(&quot;public %s %s() {&quot;,</span>
<span class="fc" id="L654">                        field.valueType(), camelCase(&quot;get&quot;, field.name()))</span>
<span class="fc" id="L655">              .begin();</span>

<span class="fc bfc" id="L657" title="All 2 branches covered.">        if ((field.isPrimitiveJavaValue() ||</span>
<span class="fc bfc" id="L658" title="All 2 branches covered.">             field.field().hasDefaultValue()) &amp;&amp;</span>
<span class="fc bfc" id="L659" title="All 2 branches covered.">            !field.alwaysPresent()){</span>
<span class="fc" id="L660">            writer.formatln(&quot;return %s() ? %s : %s;&quot;,</span>
<span class="fc" id="L661">                            field.isSet(),</span>
<span class="fc" id="L662">                            field.member(),</span>
<span class="fc" id="L663">                            field.kDefault());</span>
        } else {
<span class="fc" id="L665">            writer.formatln(&quot;return %s;&quot;, field.member());</span>
        }

<span class="fc" id="L668">        writer.end()</span>
<span class="fc" id="L669">              .appendln('}')</span>
<span class="fc" id="L670">              .newline();</span>
<span class="fc" id="L671">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>