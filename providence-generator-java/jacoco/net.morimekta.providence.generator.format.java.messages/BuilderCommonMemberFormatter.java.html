<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BuilderCommonMemberFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Providence Generator : Java</a> &gt; <a href="index.source.html" class="el_package">net.morimekta.providence.generator.format.java.messages</a> &gt; <span class="el_source">BuilderCommonMemberFormatter.java</span></div><h1>BuilderCommonMemberFormatter.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016 Providence Authors
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package net.morimekta.providence.generator.format.java.messages;

import net.morimekta.providence.PType;
import net.morimekta.providence.descriptor.PContainer;
import net.morimekta.providence.descriptor.PMap;
import net.morimekta.providence.descriptor.PPrimitive;
import net.morimekta.providence.generator.GeneratorException;
import net.morimekta.providence.generator.format.java.shared.MessageMemberFormatter;
import net.morimekta.providence.generator.format.java.utils.BlockCommentBuilder;
import net.morimekta.providence.generator.format.java.utils.JAnnotation;
import net.morimekta.providence.generator.format.java.utils.JField;
import net.morimekta.providence.generator.format.java.utils.JHelper;
import net.morimekta.providence.generator.format.java.utils.JMessage;
import net.morimekta.util.io.IndentedPrintWriter;

import javax.annotation.Nonnull;
import java.util.BitSet;
import java.util.Collection;
import java.util.Objects;

import static net.morimekta.providence.generator.format.java.messages.CoreOverridesFormatter.UNION_FIELD;
import static net.morimekta.util.Strings.camelCase;

/**
 * @author Stein Eldar Johnsen
 * @since 08.01.16.
 */
public class BuilderCommonMemberFormatter implements MessageMemberFormatter {
    protected final IndentedPrintWriter        writer;
    protected final JHelper                    helper;

    public BuilderCommonMemberFormatter(IndentedPrintWriter writer,
<span class="fc" id="L53">                                        JHelper helper) {</span>
<span class="fc" id="L54">        this.writer = writer;</span>
<span class="fc" id="L55">        this.helper = helper;</span>
<span class="fc" id="L56">    }</span>

    @Override
    public void appendClassAnnotations(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(message.descriptor())) {</span>
<span class="nc" id="L61">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }
<span class="fc" id="L63">    }</span>

    @Override
    public void appendConstructors(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L67">        appendDefaultConstructor(message);</span>
<span class="fc" id="L68">        appendMutateConstructor(message);</span>
<span class="fc" id="L69">    }</span>

    @Override
    public void appendFields(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L74">            appendUnionFields(message);</span>
        } else {
<span class="fc bfc" id="L76" title="All 2 branches covered.">            if (message.isException()) {</span>
<span class="fc" id="L77">                appendExceptionFields(message);</span>
            }
<span class="fc" id="L79">            appendStructFields(message);</span>
        }
<span class="fc" id="L81">        appendModifiedFields(message);</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">        for (JField field : message.declaredOrderFields()) {</span>
            // Void fields have no value.
<span class="fc bfc" id="L85" title="All 2 branches covered.">            if (field.isVoid()) {</span>
<span class="fc" id="L86">                continue;</span>
            }
<span class="fc" id="L88">            writer.formatln(&quot;private %s %s;&quot;, field.fieldType(), field.member());</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">            if (field.type() == PType.MESSAGE) {</span>
<span class="fc" id="L90">                writer.formatln(&quot;private %s._Builder %s_builder;&quot;, field.builderFieldType(), field.member());</span>
            }
<span class="fc" id="L92">        }</span>
<span class="fc" id="L93">        if (message.declaredOrderFields()</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">                   .size() &gt; 0) {</span>
<span class="fc" id="L95">            writer.newline();</span>
        }
<span class="fc" id="L97">    }</span>

    @Override
    public void appendMethods(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc bfc" id="L101" title="All 2 branches covered.">        for (JField field : message.declaredOrderFields()) {</span>
<span class="fc" id="L102">            appendSetter(message, field);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">            if (field.container()) {</span>
<span class="fc" id="L104">                appendAdder(message, field);</span>
            }
<span class="fc" id="L106">            appendIsSet(message, field);</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">            if( !message.isUnion() ) {</span>
<span class="fc" id="L108">                appendIsModified(message, field);</span>
            }
<span class="fc" id="L110">            appendResetter(message, field);</span>
<span class="fc" id="L111">            appendMutableGetters(message, field);</span>
<span class="fc" id="L112">        }</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if( message.isUnion() ) {</span>
<span class="fc" id="L114">            appendIsUnionModified(message);</span>
        }
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (message.isException()) {</span>
<span class="fc" id="L117">            appendInitCause(message);</span>
        }
<span class="fc" id="L119">        appendEquals(message);</span>
<span class="fc" id="L120">        appendHashCode(message);</span>
<span class="fc" id="L121">    }</span>

    @Override
    public void appendExtraProperties(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L125">        appendBuilderBuild(message);</span>
<span class="fc" id="L126">    }</span>

    private void appendBuilderBuild(JMessage&lt;?&gt; message) {
<span class="fc" id="L129">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L130">              .formatln(&quot;public %s build() {&quot;, message.instanceType())</span>
<span class="fc" id="L131">              .begin();</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (message.isException()) {</span>
<span class="fc" id="L133">            writer.formatln(&quot;%s e = new %s(this);&quot;, message.instanceType(), message.instanceType())</span>
<span class="fc" id="L134">                  .newline();</span>

<span class="fc" id="L136">            writer.appendln(&quot;try {&quot;)</span>
<span class="fc" id="L137">                  .appendln(&quot;    StackTraceElement[] stackTrace = e.getStackTrace();&quot;)</span>
<span class="fc" id="L138">                  .appendln(&quot;    StackTraceElement[] subTrace = new StackTraceElement[stackTrace.length - 1];&quot;)</span>
<span class="fc" id="L139">                  .appendln(&quot;    System.arraycopy(stackTrace, 1, subTrace, 0, subTrace.length);&quot;)</span>
<span class="fc" id="L140">                  .appendln(&quot;    e.setStackTrace(subTrace);&quot;)</span>
<span class="fc" id="L141">                  .appendln(&quot;} catch (Throwable ignored) {&quot;)</span>
<span class="fc" id="L142">                  .appendln(&quot;}&quot;)</span>
<span class="fc" id="L143">                  .newline();</span>

<span class="fc" id="L145">            writer.appendln(&quot;if (cause != null) {&quot;)</span>
<span class="fc" id="L146">                  .appendln(&quot;    e.initCause(cause);&quot;)</span>
<span class="fc" id="L147">                  .appendln(&quot;}&quot;)</span>
<span class="fc" id="L148">                  .newline()</span>
<span class="fc" id="L149">                  .appendln(&quot;return e;&quot;);</span>
        } else {
<span class="fc" id="L151">            writer.formatln(&quot;return new %s(this);&quot;, message.instanceType());</span>
        }
<span class="fc" id="L153">        writer.end()</span>
<span class="fc" id="L154">              .appendln('}');</span>
<span class="fc" id="L155">    }</span>

    private void appendEquals(JMessage&lt;?&gt; message) {
<span class="fc" id="L158">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L159">              .appendln(&quot;public boolean equals(Object o) {&quot;)</span>
<span class="fc" id="L160">              .begin()</span>
<span class="fc" id="L161">              .appendln(&quot;if (o == this) return true;&quot;)</span>
<span class="fc" id="L162">              .appendln(&quot;if (o == null || !o.getClass().equals(getClass())) return false;&quot;);</span>
<span class="fc" id="L163">        if (message.numericalOrderFields()</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">                   .size() &gt; 0) {</span>
<span class="fc" id="L165">            writer.formatln(&quot;%s._Builder other = (%s._Builder) o;&quot;, message.instanceType(), message.instanceType())</span>
<span class="fc" id="L166">                  .appendln(&quot;return &quot;);</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">            if (message.isUnion()) {</span>
<span class="fc" id="L168">                writer.format(&quot;%s.equals(%s, other.%s)&quot;,</span>
<span class="fc" id="L169">                              Objects.class.getName(),</span>
                              UNION_FIELD,
                              UNION_FIELD);
            } else {
<span class="fc" id="L173">                writer.format(&quot;%s.equals(optionals, other.optionals)&quot;,</span>
<span class="fc" id="L174">                              Objects.class.getName());</span>
            }

<span class="fc bfc" id="L177" title="All 2 branches covered.">            for (JField field : message.declaredOrderFields()) {</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">                if (field.isVoid()) continue;</span>

<span class="fc" id="L180">                writer.append(&quot; &amp;&amp;&quot;)</span>
<span class="fc" id="L181">                      .appendln(&quot;       &quot;);</span>
<span class="fc" id="L182">                writer.format(&quot;%s.equals(%s, other.%s)&quot;,</span>
<span class="fc" id="L183">                              Objects.class.getName(),</span>
<span class="fc" id="L184">                              field.member(), field.member());</span>
<span class="fc" id="L185">            }</span>
<span class="fc" id="L186">            writer.append(';');</span>
        } else {
<span class="fc" id="L188">            writer.appendln(&quot;return true;&quot;);</span>
        }
<span class="fc" id="L190">        writer.end()</span>
<span class="fc" id="L191">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L192">              .newline();</span>
<span class="fc" id="L193">    }</span>

    private void appendHashCode(JMessage&lt;?&gt; message) {
<span class="fc" id="L196">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L197">              .appendln(&quot;public int hashCode() {&quot;)</span>
<span class="fc" id="L198">              .begin()</span>
<span class="fc" id="L199">              .formatln(&quot;return %s.hash(&quot;,</span>
<span class="fc" id="L200">                        Objects.class.getName())</span>
<span class="fc" id="L201">              .begin(&quot;        &quot;)</span>
<span class="fc" id="L202">              .formatln(&quot;%s.class&quot;, message.instanceType());</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">        if (!message.isUnion()) {</span>
<span class="fc" id="L204">            writer.append(&quot;, optionals&quot;);</span>
        }
<span class="fc" id="L206">        message.numericalOrderFields()</span>
<span class="fc" id="L207">               .stream()</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">               .filter(field -&gt; !field.isVoid())</span>
<span class="fc" id="L209">               .forEach(field -&gt; {</span>
<span class="fc" id="L210">                   writer.append(&quot;,&quot;);</span>
<span class="fc" id="L211">                   writer.formatln(&quot;_Field.%s, %s&quot;, field.fieldEnum(), field.member());</span>
<span class="fc" id="L212">               });</span>

<span class="fc" id="L214">        writer.end()</span>
<span class="fc" id="L215">              .append(&quot;);&quot;)</span>
<span class="fc" id="L216">              .end()</span>
<span class="fc" id="L217">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L218">              .newline();</span>
<span class="fc" id="L219">    }</span>

    private void appendUnionFields(JMessage&lt;?&gt; message) {
<span class="fc" id="L222">        writer.formatln(&quot;private _Field %s;&quot;, UNION_FIELD)</span>
<span class="fc" id="L223">              .newline();</span>
<span class="fc" id="L224">    }</span>

    private void appendExceptionFields(JMessage&lt;?&gt; message) {
<span class="fc" id="L227">        writer.formatln(&quot;private Throwable cause;&quot;);</span>
<span class="fc" id="L228">    }</span>

    private void appendStructFields(JMessage&lt;?&gt; message) {
<span class="fc" id="L231">        writer.formatln(&quot;private %s optionals;&quot;,</span>
<span class="fc" id="L232">                        BitSet.class.getName());</span>
<span class="fc" id="L233">    }</span>

    private void appendModifiedFields(JMessage&lt;?&gt; message) {
<span class="fc bfc" id="L236" title="All 2 branches covered.">        if (!message.isUnion()) {</span>
<span class="fc" id="L237">            writer.formatln(&quot;private %s modified;&quot;, BitSet.class.getName())</span>
<span class="fc" id="L238">                  .newline();</span>
        } else {
<span class="fc" id="L240">            writer.formatln(&quot;private %s modified;&quot;, boolean.class.getName())</span>
<span class="fc" id="L241">                  .newline();</span>
        }
<span class="fc" id="L243">    }</span>

    private void appendDefaultConstructor(JMessage&lt;?&gt; message) throws GeneratorException {
<span class="fc" id="L246">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc" id="L247">        comment.comment(&quot;Make a &quot; + message.descriptor().getQualifiedName() + &quot; builder.&quot;)</span>
<span class="fc" id="L248">               .finish();</span>
<span class="fc" id="L249">        writer.appendln(&quot;public _Builder() {&quot;)</span>
<span class="fc" id="L250">              .begin();</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">        if (!message.isUnion()) {</span>
<span class="fc" id="L252">            writer.formatln(&quot;optionals = new %s(%d);&quot;,</span>
<span class="fc" id="L253">                            BitSet.class.getName(),</span>
<span class="fc" id="L254">                            message.declaredOrderFields()</span>
<span class="fc" id="L255">                                   .size());</span>
<span class="fc" id="L256">            writer.formatln(&quot;modified = new %s(%d);&quot;,</span>
<span class="fc" id="L257">                            BitSet.class.getName(),</span>
<span class="fc" id="L258">                            message.declaredOrderFields()</span>
<span class="fc" id="L259">                                   .size());</span>
        } else {
<span class="fc" id="L261">            writer.appendln(&quot;modified = false;&quot;);</span>
        }

<span class="fc bfc" id="L264" title="All 2 branches covered.">        for (JField field : message.declaredOrderFields()) {</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">            if (field.alwaysPresent()) {</span>
<span class="fc" id="L266">                writer.formatln(&quot;%s = %s;&quot;, field.member(), field.kDefault());</span>
            }
<span class="fc" id="L268">        }</span>
<span class="fc" id="L269">        writer.end()</span>
<span class="fc" id="L270">              .appendln('}')</span>
<span class="fc" id="L271">              .newline();</span>
<span class="fc" id="L272">    }</span>

    private void appendMutateConstructor(JMessage&lt;?&gt; message) {
<span class="fc" id="L275">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc" id="L276">        comment.comment(&quot;Make a mutating builder off a base &quot; + message.descriptor().getQualifiedName() + &quot;.&quot;)</span>
<span class="fc" id="L277">               .newline()</span>
<span class="fc" id="L278">               .param_(&quot;base&quot;, &quot;The base &quot; + message.descriptor().getName())</span>
<span class="fc" id="L279">               .finish();</span>
<span class="fc" id="L280">        writer.formatln(&quot;public _Builder(%s base) {&quot;, message.instanceType())</span>
<span class="fc" id="L281">              .begin()</span>
<span class="fc" id="L282">              .appendln(&quot;this();&quot;)</span>
<span class="fc" id="L283">              .newline();</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L285">            writer.formatln(&quot;%s = base.%s;&quot;, UNION_FIELD, UNION_FIELD)</span>
<span class="fc" id="L286">                  .newline();</span>
        }
<span class="fc bfc" id="L288" title="All 2 branches covered.">        for (JField field : message.declaredOrderFields()) {</span>
<span class="fc bfc" id="L289" title="All 4 branches covered.">            boolean checkPresence = message.isUnion() ? field.container() : !field.alwaysPresent();</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">            if (checkPresence) {</span>
<span class="fc" id="L291">                writer.formatln(&quot;if (base.%s()) {&quot;, field.presence())</span>
<span class="fc" id="L292">                      .begin();</span>
            }
<span class="fc bfc" id="L294" title="All 2 branches covered.">            if (!message.isUnion()) {</span>
<span class="fc" id="L295">                writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
            }
<span class="fc bfc" id="L297" title="All 2 branches covered.">            if (field.type() != PType.VOID) {</span>
<span class="fc" id="L298">                writer.formatln(&quot;%s = base.%s;&quot;, field.member(), field.member());</span>
            }
<span class="fc bfc" id="L300" title="All 2 branches covered.">            if (checkPresence) {</span>
<span class="fc" id="L301">                writer.end()</span>
<span class="fc" id="L302">                      .appendln('}');</span>
            }
<span class="fc" id="L304">        }</span>

<span class="fc" id="L306">        writer.end()</span>
<span class="fc" id="L307">              .appendln('}')</span>
<span class="fc" id="L308">              .newline();</span>
<span class="fc" id="L309">    }</span>

    private void appendSetter(JMessage message, JField field) throws GeneratorException {
<span class="fc" id="L312">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L314">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L316">            comment.comment(&quot;Sets the value of &quot; + field.name() + &quot;.&quot;);</span>
        }
<span class="fc" id="L318">        comment.newline();</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">        if (!field.isVoid()) {</span>
<span class="fc" id="L320">            comment.param_(&quot;value&quot;, &quot;The new value&quot;);</span>
        }
<span class="fc" id="L322">        comment.return_(&quot;The builder&quot;)</span>
<span class="fc" id="L323">               .finish();</span>
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(field)) {</span>
<span class="nc" id="L325">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }
<span class="fc" id="L327">        writer.appendln(JAnnotation.NON_NULL);</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">        if (field.isVoid()) {</span>
            // Void fields have no value.
<span class="fc" id="L330">            writer.formatln(&quot;public _Builder %s() {&quot;, field.setter());</span>
<span class="fc bfc" id="L331" title="All 4 branches covered.">        } else if (field.type() == PType.SET || field.type() == PType.LIST) {</span>
<span class="fc" id="L332">            PContainer&lt;?&gt; cType = (PContainer&lt;?&gt;) field.field()</span>
<span class="fc" id="L333">                                                       .getDescriptor();</span>
<span class="fc" id="L334">            String iType = helper.getFieldType(cType.itemDescriptor());</span>
<span class="fc" id="L335">            writer.formatln(&quot;public _Builder %s(%s&lt;%s&gt; value) {&quot;,</span>
<span class="fc" id="L336">                            field.setter(), Collection.class.getName(), iType);</span>
<span class="fc" id="L337">        } else {</span>
<span class="fc" id="L338">            writer.formatln(&quot;public _Builder %s(%s value) {&quot;, field.setter(), field.valueType());</span>
        }
<span class="fc" id="L340">        writer.begin();</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">        if (!field.isPrimitiveJavaValue()) {</span>
<span class="fc" id="L342">            writer.formatln(&quot;if (value == null) {&quot;)</span>
<span class="fc" id="L343">                  .formatln(&quot;    return %s();&quot;, field.resetter())</span>
<span class="fc" id="L344">                  .appendln('}')</span>
<span class="fc" id="L345">                  .newline();</span>
        }

<span class="fc bfc" id="L348" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L349">            writer.formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L350">            writer.appendln(&quot;modified = true;&quot;);</span>
        } else {
<span class="fc" id="L352">            writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L353">            writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
        }

<span class="pc bfc" id="L356" title="All 4 branches covered.">        switch (field.type()) {</span>
            case VOID:
                // Void fields have no value.
<span class="fc" id="L359">                break;</span>
            case SET:
            case LIST:
            case MAP:
<span class="fc" id="L363">                writer.formatln(&quot;%s = %s;&quot;, field.member(), field.fieldInstanceCopy(&quot;value&quot;));</span>
<span class="fc" id="L364">                break;</span>
            case MESSAGE:
<span class="fc" id="L366">                writer.formatln(&quot;%s = value;&quot;, field.member());</span>
<span class="fc" id="L367">                writer.formatln(&quot;%s_builder = null;&quot;, field.member());</span>
<span class="fc" id="L368">                break;</span>
            default:
<span class="fc" id="L370">                writer.formatln(&quot;%s = value;&quot;, field.member());</span>
                break;
        }

<span class="fc" id="L374">        writer.appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L375">              .end()</span>
<span class="fc" id="L376">              .appendln('}')</span>
<span class="fc" id="L377">              .newline();</span>
<span class="fc" id="L378">    }</span>

    private void appendAdder(JMessage message, JField field) throws GeneratorException {
<span class="fc" id="L381">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>

<span class="fc bfc" id="L383" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L384">            comment.comment(field.comment());</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">        } else if (field.type() == PType.MAP) {</span>
<span class="fc" id="L386">            comment.comment(&quot;Adds a mapping to &quot; + field.name() + &quot;.&quot;);</span>
        } else {
<span class="fc" id="L388">            comment.comment(&quot;Adds entries to &quot; + field.name() + &quot;.&quot;);</span>
        }
<span class="fc" id="L390">        comment.newline();</span>

<span class="fc bfc" id="L392" title="All 2 branches covered.">        if (field.type() == PType.MAP) {</span>
<span class="fc" id="L393">            comment.param_(&quot;key&quot;, &quot;The inserted key&quot;)</span>
<span class="fc" id="L394">                   .param_(&quot;value&quot;, &quot;The inserted value&quot;);</span>
        } else {
<span class="fc" id="L396">            comment.param_(&quot;values&quot;, &quot;The added value&quot;);</span>
        }
<span class="fc" id="L398">        comment.return_(&quot;The builder&quot;)</span>
<span class="fc" id="L399">               .finish();</span>

<span class="pc bpc" id="L401" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(field)) {</span>
<span class="nc" id="L402">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }
<span class="fc" id="L404">        writer.appendln(JAnnotation.NON_NULL);</span>

<span class="pc bpc" id="L406" title="1 of 3 branches missed.">        switch (field.type()) {</span>
            case MAP: {
<span class="fc" id="L408">                PMap&lt;?, ?&gt; mType = (PMap&lt;?, ?&gt;) field.field()</span>
<span class="fc" id="L409">                                                     .getDescriptor();</span>
<span class="fc" id="L410">                String mkType = helper.getValueType(mType.keyDescriptor());</span>
<span class="fc" id="L411">                String miType = helper.getValueType(mType.itemDescriptor());</span>

<span class="fc" id="L413">                writer.formatln(&quot;public _Builder %s(%s key, %s value) {&quot;, field.adder(), mkType, miType)</span>
<span class="fc" id="L414">                      .begin();</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">                if (message.isUnion()) {</span>
<span class="fc" id="L416">                    writer.formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L417">                    writer.appendln(&quot;modified = true;&quot;);</span>
                } else {
<span class="fc" id="L419">                    writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L420">                    writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
                }
<span class="fc" id="L422">                writer.formatln(&quot;%s().put(key, value);&quot;, field.mutable())</span>
<span class="fc" id="L423">                      .appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L424">                      .end()</span>
<span class="fc" id="L425">                      .appendln('}')</span>
<span class="fc" id="L426">                      .newline();</span>

<span class="fc" id="L428">                break;</span>
            }
            case SET:
            case LIST: {
<span class="fc" id="L432">                PContainer&lt;?&gt; lType = (PContainer&lt;?&gt;) field.field()</span>
<span class="fc" id="L433">                                                                 .getDescriptor();</span>
<span class="fc" id="L434">                String liType = helper.getValueType(lType.itemDescriptor());</span>

<span class="fc" id="L436">                writer.formatln(&quot;public _Builder %s(%s... values) {&quot;, field.adder(), liType)</span>
<span class="fc" id="L437">                      .begin();</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">                if (message.isUnion()) {</span>
<span class="fc" id="L439">                    writer.formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L440">                    writer.appendln(&quot;modified = true;&quot;);</span>
                } else {
<span class="fc" id="L442">                    writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L443">                    writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
                }
<span class="fc" id="L445">                writer.formatln(&quot;%s _container = %s();&quot;, field.fieldType(), field.mutable())</span>
<span class="fc" id="L446">                      .formatln(&quot;for (%s item : values) {&quot;, liType)</span>
<span class="fc" id="L447">                      .begin()</span>
<span class="fc" id="L448">                      .appendln(&quot;_container.add(item);&quot;)</span>
<span class="fc" id="L449">                      .end()</span>
<span class="fc" id="L450">                      .appendln('}')</span>
<span class="fc" id="L451">                      .appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L452">                      .end()</span>
<span class="fc" id="L453">                      .appendln('}')</span>
<span class="fc" id="L454">                      .newline();</span>

<span class="fc" id="L456">                break;</span>
            }
        }
<span class="fc" id="L459">    }</span>

    private void appendIsSet(JMessage message, JField field) {
<span class="fc" id="L462">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L464">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L466">            comment.comment(&quot;Checks for presence of the &quot; + field.name() + &quot; field.&quot;);</span>
        }

<span class="fc" id="L469">        comment.newline()</span>
<span class="fc" id="L470">               .return_(String.format(&quot;True if %s has been set.&quot;, field.name()))</span>
<span class="fc" id="L471">               .finish();</span>
<span class="fc" id="L472">        writer.formatln(&quot;public boolean %s() {&quot;, field.isSet())</span>
<span class="fc" id="L473">              .begin();</span>

<span class="fc bfc" id="L475" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L476">            writer.formatln(&quot;return %s == _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
        } else {
<span class="fc" id="L478">            writer.formatln(&quot;return optionals.get(%d);&quot;, field.index());</span>
        }
<span class="fc" id="L480">        writer.end()</span>
<span class="fc" id="L481">              .appendln('}')</span>
<span class="fc" id="L482">              .newline();</span>
<span class="fc" id="L483">    }</span>

    private void appendIsModified(JMessage message, JField field) {
<span class="fc" id="L486">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L488">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L490">            comment.comment(&quot;Checks if &quot; + field.name() + &quot; has been modified since the _Builder was created.&quot;);</span>
        }

<span class="fc" id="L493">        comment.newline()</span>
<span class="fc" id="L494">               .return_(String.format(&quot;True if %s has been modified.&quot;, field.name()))</span>
<span class="fc" id="L495">               .finish();</span>
<span class="fc" id="L496">        writer.formatln(&quot;public boolean %s() {&quot;, field.isModified())</span>
<span class="fc" id="L497">              .begin();</span>
<span class="fc" id="L498">        writer.formatln(&quot;return modified.get(%d);&quot;, field.index());</span>
<span class="fc" id="L499">        writer.end()</span>
<span class="fc" id="L500">              .appendln('}')</span>
<span class="fc" id="L501">              .newline();</span>
<span class="fc" id="L502">    }</span>

    private void appendIsUnionModified(JMessage message) {
<span class="fc" id="L505">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc" id="L506">        comment.comment(&quot;Checks if &quot; + message.descriptor().getName() + &quot; has been modified since the _Builder &quot; +</span>
                        &quot;was created.&quot;);

<span class="fc" id="L509">        comment.newline()</span>
<span class="fc" id="L510">               .return_(String.format(&quot;True if %s has been modified.&quot;, message.descriptor().getName()))</span>
<span class="fc" id="L511">               .finish();</span>
<span class="fc" id="L512">        writer.formatln(&quot;public boolean %s() {&quot;, &quot;isUnionModified&quot;)</span>
<span class="fc" id="L513">              .begin();</span>
<span class="fc" id="L514">        writer.appendln(&quot;return modified;&quot;);</span>
<span class="fc" id="L515">        writer.end()</span>
<span class="fc" id="L516">              .appendln('}')</span>
<span class="fc" id="L517">              .newline();</span>
<span class="fc" id="L518">    }</span>

    private void appendResetter(JMessage message, JField field) {
<span class="fc" id="L521">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L522" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L523">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L525">            comment.comment(&quot;Clears the &quot; + field.name() + &quot; field.&quot;);</span>
        }
<span class="fc" id="L527">        comment.newline()</span>
<span class="fc" id="L528">               .return_(&quot;The builder&quot;)</span>
<span class="fc" id="L529">               .finish();</span>
<span class="fc" id="L530">        writer.appendln(JAnnotation.NON_NULL);</span>
<span class="fc" id="L531">        writer.formatln(&quot;public _Builder %s() {&quot;, field.resetter())</span>
<span class="fc" id="L532">              .begin();</span>

<span class="fc bfc" id="L534" title="All 2 branches covered.">        if (message.isUnion()) {</span>
<span class="fc" id="L535">            writer.formatln(&quot;if (%s == _Field.%s) %s = null;&quot;, UNION_FIELD, field.fieldEnum(), UNION_FIELD);</span>
<span class="fc" id="L536">            writer.appendln(&quot;modified = true;&quot;);</span>
        } else {
<span class="fc" id="L538">            writer.formatln(&quot;optionals.clear(%d);&quot;, field.index());</span>
<span class="fc" id="L539">            writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
        }

        // Void fields have no value.
<span class="fc bfc" id="L543" title="All 2 branches covered.">        if (!field.isVoid()) {</span>
<span class="fc bfc" id="L544" title="All 2 branches covered.">            if (field.alwaysPresent()) {</span>
<span class="fc" id="L545">                writer.formatln(&quot;%s = %s;&quot;, field.member(), field.kDefault());</span>
            } else {
<span class="fc" id="L547">                writer.formatln(&quot;%s = null;&quot;, field.member());</span>
<span class="fc bfc" id="L548" title="All 2 branches covered.">                if (field.type() == PType.MESSAGE) {</span>
<span class="fc" id="L549">                    writer.formatln(&quot;%s_builder = null;&quot;, field.member());</span>
                }
            }
        }

<span class="fc" id="L554">        writer.appendln(&quot;return this;&quot;)</span>
<span class="fc" id="L555">              .end()</span>
<span class="fc" id="L556">              .appendln('}')</span>
<span class="fc" id="L557">              .newline();</span>
<span class="fc" id="L558">    }</span>

    /**
     * Get mutable values. This returns message builders for messages, collection
     * builders for collections, and the normal immutable value for everything
     * else.
     *
     * @param message The message to get mutable getters for.
     * @param field The field to generate getter for.
     */
    private void appendMutableGetters(JMessage message, JField field) throws GeneratorException {
<span class="fc bfc" id="L569" title="All 2 branches covered.">        if (field.field().getDescriptor() instanceof PPrimitive ||</span>
<span class="fc bfc" id="L570" title="All 2 branches covered.">            field.type() == PType.ENUM) {</span>
            // The other fields will have ordinary non-mutable getters.
<span class="fc" id="L572">            appendGetter(field);</span>
<span class="fc" id="L573">            return;</span>
        }

<span class="fc" id="L576">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">        if (field.hasComment()) {</span>
<span class="fc" id="L578">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L580">            comment.comment(&quot;Gets the builder for the contained &quot; + field.name() + &quot;.&quot;);</span>
        }
<span class="fc" id="L582">        comment.newline()</span>
<span class="fc" id="L583">               .return_(&quot;The field builder&quot;)</span>
<span class="fc" id="L584">               .finish();</span>
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(field)) {</span>
<span class="nc" id="L586">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }
<span class="fc" id="L588">        writer.appendln(JAnnotation.NON_NULL);</span>
<span class="pc bpc" id="L589" title="1 of 3 branches missed.">        switch (field.type()) {</span>
            case MESSAGE: {
<span class="fc" id="L591">                writer.formatln(&quot;public %s._Builder %s() {&quot;, field.instanceType(), field.mutable())</span>
<span class="fc" id="L592">                      .begin();</span>

<span class="fc bfc" id="L594" title="All 2 branches covered.">                if (message.isUnion()) {</span>
<span class="fc" id="L595">                    writer.formatln(&quot;if (%s != _Field.%s) {&quot;, UNION_FIELD, field.fieldEnum())</span>
<span class="fc" id="L596">                          .formatln(&quot;    %s();&quot;, field.resetter())</span>
<span class="fc" id="L597">                          .appendln('}')</span>
<span class="fc" id="L598">                          .formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L599">                    writer.appendln(&quot;modified = true;&quot;);</span>
                } else {
<span class="fc" id="L601">                    writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L602">                    writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
                }

<span class="fc" id="L605">                writer.newline()</span>
<span class="fc" id="L606">                      .formatln(&quot;if (%s != null) {&quot;, field.member())</span>
<span class="fc" id="L607">                      .formatln(&quot;    %s_builder = %s.mutate();&quot;, field.member(), field.member())</span>
<span class="fc" id="L608">                      .formatln(&quot;    %s = null;&quot;, field.member())</span>
<span class="fc" id="L609">                      .formatln(&quot;} else if (%s_builder == null) {&quot;, field.member())</span>
<span class="fc" id="L610">                      .formatln(&quot;    %s_builder = %s.builder();&quot;, field.member(), field.instanceType())</span>
<span class="fc" id="L611">                      .appendln('}')</span>
<span class="fc" id="L612">                      .formatln(&quot;return %s_builder;&quot;, field.member());</span>

<span class="fc" id="L614">                writer.end()</span>
<span class="fc" id="L615">                      .appendln('}')</span>
<span class="fc" id="L616">                      .newline();</span>
<span class="fc" id="L617">                break;</span>
            }
            case SET:
            case LIST:
            case MAP:
<span class="fc" id="L622">                writer.formatln(&quot;public %s %s() {&quot;, field.fieldType(), field.mutable())</span>
<span class="fc" id="L623">                      .begin();</span>

<span class="fc bfc" id="L625" title="All 2 branches covered.">                if (message.isUnion()) {</span>
<span class="fc" id="L626">                    writer.formatln(&quot;if (%s != _Field.%s) {&quot;, UNION_FIELD, field.fieldEnum())</span>
<span class="fc" id="L627">                          .formatln(&quot;    %s();&quot;, field.resetter())</span>
<span class="fc" id="L628">                          .appendln('}')</span>
<span class="fc" id="L629">                          .formatln(&quot;%s = _Field.%s;&quot;, UNION_FIELD, field.fieldEnum());</span>
<span class="fc" id="L630">                    writer.appendln(&quot;modified = true;&quot;);</span>
                } else {
<span class="fc" id="L632">                    writer.formatln(&quot;optionals.set(%d);&quot;, field.index());</span>
<span class="fc" id="L633">                    writer.formatln(&quot;modified.set(%d);&quot;, field.index());</span>
                }
<span class="fc" id="L635">                writer.newline()</span>
<span class="fc" id="L636">                      .formatln(&quot;if (%s == null) {&quot;, field.member())</span>
<span class="fc" id="L637">                      .formatln(&quot;    %s = new %s&lt;&gt;();&quot;, field.member(), field.builderMutableType())</span>
<span class="fc" id="L638">                      .formatln(&quot;} else if (!(%s instanceof %s)) {&quot;, field.member(), field.builderMutableType())</span>
<span class="fc" id="L639">                      .formatln(&quot;    %s = new %s&lt;&gt;(%s);&quot;, field.member(), field.builderMutableType(), field.member())</span>
<span class="fc" id="L640">                      .appendln(&quot;}&quot;);</span>

<span class="fc" id="L642">                writer.formatln(&quot;return %s;&quot;, field.member());</span>

<span class="fc" id="L644">                writer.end()</span>
<span class="fc" id="L645">                      .appendln('}')</span>
<span class="fc" id="L646">                      .newline();</span>
<span class="fc" id="L647">                break;</span>
            default:
<span class="nc" id="L649">                throw new GeneratorException(&quot;Unexpected field type: &quot; + field.type());</span>
        }
<span class="fc" id="L651">    }</span>

    private void appendGetter(JField field) {
<span class="fc bfc" id="L654" title="All 2 branches covered.">        if (field.isVoid()) {</span>
<span class="fc" id="L655">            return;</span>
        }

<span class="fc" id="L658">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">        if (field.hasComment()) {</span>
<span class="nc" id="L660">            comment.comment(field.comment());</span>
        } else {
<span class="fc" id="L662">            comment.comment(&quot;Gets the value of the contained &quot; + field.name() + &quot;.&quot;);</span>
        }
<span class="fc" id="L664">        comment.newline()</span>
<span class="fc" id="L665">               .return_(&quot;The field value&quot;)</span>
<span class="fc" id="L666">               .finish();</span>
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">        if (JAnnotation.isDeprecated(field)) {</span>
<span class="nc" id="L668">            writer.appendln(JAnnotation.DEPRECATED);</span>
        }

        // Builder getters are *always* get*, never is* (e.g. for bool)
<span class="fc" id="L672">        writer.formatln(&quot;public %s %s() {&quot;,</span>
<span class="fc" id="L673">                        field.valueType(), camelCase(&quot;get&quot;, field.name()))</span>
<span class="fc" id="L674">              .begin();</span>

<span class="fc bfc" id="L676" title="All 2 branches covered.">        if ((field.isPrimitiveJavaValue() ||</span>
<span class="fc bfc" id="L677" title="All 2 branches covered.">             field.field().hasDefaultValue()) &amp;&amp;</span>
<span class="fc bfc" id="L678" title="All 2 branches covered.">            !field.alwaysPresent()){</span>
<span class="fc" id="L679">            writer.formatln(&quot;return %s() ? %s : %s;&quot;,</span>
<span class="fc" id="L680">                            field.isSet(),</span>
<span class="fc" id="L681">                            field.member(),</span>
<span class="fc" id="L682">                            field.kDefault());</span>
        } else {
<span class="fc" id="L684">            writer.formatln(&quot;return %s;&quot;, field.member());</span>
        }

<span class="fc" id="L687">        writer.end()</span>
<span class="fc" id="L688">              .appendln('}')</span>
<span class="fc" id="L689">              .newline();</span>
<span class="fc" id="L690">    }</span>

    private void appendInitCause(JMessage&lt;?&gt; message) {
<span class="fc" id="L693">        new BlockCommentBuilder(writer)</span>
<span class="fc" id="L694">                .comment(&quot;Initializes the cause of the &quot; + message.descriptor().getQualifiedName())</span>
<span class="fc" id="L695">                .newline()</span>
<span class="fc" id="L696">                .param_(&quot;cause&quot;, &quot;The cause&quot;)</span>
<span class="fc" id="L697">                .return_(&quot;Builder instance&quot;)</span>
<span class="fc" id="L698">                .finish();</span>
<span class="fc" id="L699">        writer.appendln(JAnnotation.NON_NULL);</span>
<span class="fc" id="L700">        writer.appendln(&quot;public _Builder initCause(Throwable cause) {&quot;)</span>
<span class="fc" id="L701">              .appendln(&quot;    this.cause = cause;&quot;)</span>
<span class="fc" id="L702">              .appendln(&quot;    return this;&quot;)</span>
<span class="fc" id="L703">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L704">              .newline();</span>
<span class="fc" id="L705">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>