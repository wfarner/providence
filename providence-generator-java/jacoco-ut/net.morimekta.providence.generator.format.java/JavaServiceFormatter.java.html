<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JavaServiceFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Providence Generator : Java</a> &gt; <a href="index.source.html" class="el_package">net.morimekta.providence.generator.format.java</a> &gt; <span class="el_source">JavaServiceFormatter.java</span></div><h1>JavaServiceFormatter.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016 Providence Authors
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package net.morimekta.providence.generator.format.java;

import net.morimekta.providence.PApplicationException;
import net.morimekta.providence.PApplicationExceptionType;
import net.morimekta.providence.PClient;
import net.morimekta.providence.PMessage;
import net.morimekta.providence.PProcessor;
import net.morimekta.providence.PServiceCall;
import net.morimekta.providence.PServiceCallHandler;
import net.morimekta.providence.PServiceCallType;
import net.morimekta.providence.descriptor.PField;
import net.morimekta.providence.descriptor.PService;
import net.morimekta.providence.descriptor.PServiceMethod;
import net.morimekta.providence.descriptor.PServiceProvider;
import net.morimekta.providence.descriptor.PStructDescriptor;
import net.morimekta.providence.descriptor.PUnionDescriptor;
import net.morimekta.providence.generator.GeneratorException;
import net.morimekta.providence.generator.format.java.shared.BaseServiceFormatter;
import net.morimekta.providence.generator.format.java.utils.BlockCommentBuilder;
import net.morimekta.providence.generator.format.java.utils.JField;
import net.morimekta.providence.generator.format.java.utils.JHelper;
import net.morimekta.providence.generator.format.java.utils.JMessage;
import net.morimekta.providence.generator.format.java.utils.JService;
import net.morimekta.providence.generator.format.java.utils.JServiceMethod;
import net.morimekta.providence.reflect.contained.CService;
import net.morimekta.providence.serializer.SerializerException;
import net.morimekta.util.Strings;
import net.morimekta.util.io.IndentedPrintWriter;

import java.io.IOException;

public class JavaServiceFormatter implements BaseServiceFormatter {
    private final JHelper              helper;
    private final JavaMessageFormatter messageFormat;
    private final IndentedPrintWriter  writer;
    private final JavaOptions          options;

    JavaServiceFormatter(IndentedPrintWriter writer,
                         JHelper helper,
                         JavaMessageFormatter messageFormat,
<span class="fc" id="L61">                         JavaOptions options) {</span>
<span class="fc" id="L62">        this.writer = writer;</span>
<span class="fc" id="L63">        this.helper = helper;</span>
<span class="fc" id="L64">        this.messageFormat = messageFormat;</span>
<span class="fc" id="L65">        this.options = options;</span>
<span class="fc" id="L66">    }</span>

    @Override
    public void appendServiceClass(CService cs) throws GeneratorException, IOException {
<span class="fc" id="L70">        JService service = new JService(cs, helper);</span>

<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (cs.getDocumentation() != null) {</span>
<span class="fc" id="L73">            new BlockCommentBuilder(writer)</span>
<span class="fc" id="L74">                    .comment(cs.getDocumentation())</span>
<span class="fc" id="L75">                    .finish();</span>
        }

<span class="fc" id="L78">        writer.appendln(&quot;@SuppressWarnings(\&quot;unused\&quot;)&quot;)</span>
<span class="fc" id="L79">              .formatln(&quot;public class %s {&quot;, service.className())</span>
<span class="fc" id="L80">              .begin();</span>

<span class="fc" id="L82">        appendIface(writer, service);</span>

<span class="fc" id="L84">        appendClient(writer, service);</span>

<span class="fc" id="L86">        appendProcessor(writer, service);</span>

<span class="fc" id="L88">        appendDescriptor(writer, service);</span>

<span class="fc" id="L90">        appendStructs(writer, service);</span>

        // private constructor should defeat instantiation.
<span class="fc" id="L93">        writer.formatln(&quot;private %s() {}&quot;, service.className());</span>

<span class="fc" id="L95">        writer.end()</span>
<span class="fc" id="L96">              .appendln('}');</span>
<span class="fc" id="L97">    }</span>

    private void appendClient(IndentedPrintWriter writer, JService service) throws GeneratorException {
<span class="fc" id="L100">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc" id="L101">        if (service.getService()</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">                   .getDocumentation() != null) {</span>
<span class="fc" id="L103">            comment.comment(service.getService().getDocumentation())</span>
<span class="fc" id="L104">                   .newline();</span>
        }
<span class="fc" id="L106">        comment.comment(&quot;Client implementation for &quot; + service.getService().getQualifiedName())</span>
<span class="fc" id="L107">               .finish();</span>

<span class="fc" id="L109">        writer.appendln(&quot;public static class Client&quot;)</span>
<span class="fc" id="L110">              .formatln(&quot;        extends %s&quot;, PClient.class.getName())</span>
<span class="fc" id="L111">              .formatln(&quot;        implements Iface {&quot;)</span>
<span class="fc" id="L112">              .begin();</span>

<span class="fc" id="L114">        writer.formatln(&quot;private final %s handler;&quot;, PServiceCallHandler.class.getName())</span>
<span class="fc" id="L115">              .newline();</span>

<span class="fc" id="L117">        new BlockCommentBuilder(writer)</span>
<span class="fc" id="L118">                .comment(&quot;Create &quot; + service.getService().getQualifiedName() + &quot; service client.&quot;)</span>
<span class="fc" id="L119">                .newline()</span>
<span class="fc" id="L120">                .param_(&quot;handler&quot;, &quot;The client handler.&quot;)</span>
<span class="fc" id="L121">                .finish();</span>

<span class="fc" id="L123">        writer.formatln(&quot;public Client(%s handler) {&quot;, PServiceCallHandler.class.getName())</span>
<span class="fc" id="L124">              .appendln(&quot;    this.handler = handler;&quot;)</span>
<span class="fc" id="L125">              .appendln('}')</span>
<span class="fc" id="L126">              .newline();</span>

<span class="fc" id="L128">        boolean firstMethod = true;</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">        for (JServiceMethod method : service.methods()) {</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">            if (firstMethod) {</span>
<span class="fc" id="L131">                firstMethod = false;</span>
            } else {
<span class="fc" id="L133">                writer.newline();</span>
            }

<span class="fc" id="L136">            writer.appendln(&quot;@Override&quot;);</span>

            // Field ID 0 is the return type.
<span class="fc" id="L139">            JField ret = method.getResponse();</span>

<span class="fc" id="L141">            writer.appendln(&quot;public &quot;);</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">            if (ret != null) {</span>
<span class="fc" id="L143">                writer.append(ret.valueType());</span>
            } else {
<span class="fc" id="L145">                writer.append(&quot;void&quot;);</span>
            }

<span class="fc" id="L148">            writer.format(&quot; %s(&quot;, method.methodName())</span>
<span class="fc" id="L149">                  .begin(&quot;        &quot;);</span>

<span class="fc" id="L151">            boolean first = true;</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L154">                    first = false;</span>
                } else {
<span class="fc" id="L156">                    writer.append(&quot;,&quot;);</span>
                }
<span class="fc" id="L158">                writer.formatln(&quot;%s %s&quot;, param.valueType(), param.param());</span>
            }

<span class="fc" id="L161">            writer.end()</span>
<span class="fc" id="L162">                  .format(&quot;)&quot;)</span>
<span class="fc" id="L163">                  .formatln(&quot;        throws %s&quot;, IOException.class.getName())</span>
<span class="fc" id="L164">                  .begin(   &quot;               &quot;);</span>

<span class="fc bfc" id="L166" title="All 2 branches covered.">            for (JField ex : method.exceptions()) {</span>
<span class="fc" id="L167">                writer.append(&quot;,&quot;);</span>
<span class="fc" id="L168">                writer.appendln(ex.instanceType());</span>
            }

<span class="fc" id="L171">            writer.format(&quot; {&quot;)</span>
<span class="fc" id="L172">                  .end()</span>
<span class="fc" id="L173">                  .begin();</span>

<span class="fc" id="L175">            writer.formatln(&quot;%s._Builder rq = %s.builder();&quot;,</span>
<span class="fc" id="L176">                            service.getRequestClassRef(method),</span>
<span class="fc" id="L177">                            service.getRequestClassRef(method));</span>

<span class="fc bfc" id="L179" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="fc" id="L180">                writer.formatln(&quot;rq.%s(%s);&quot;, param.setter(), param.param());</span>
            }

<span class="fc bfc" id="L183" title="All 2 branches covered.">            String type = method.getMethod().isOneway()</span>
<span class="fc" id="L184">                          ? PServiceCallType.ONEWAY.name()</span>
<span class="fc" id="L185">                          : PServiceCallType.CALL.name();</span>
<span class="fc" id="L186">            writer.newline()</span>
<span class="fc" id="L187">                  .formatln(&quot;%s call = new %s&lt;&gt;(\&quot;%s\&quot;, %s.%s, getNextSequenceId(), rq.build());&quot;,</span>
<span class="fc" id="L188">                            PServiceCall.class.getName(),</span>
<span class="fc" id="L189">                            PServiceCall.class.getName(),</span>
<span class="fc" id="L190">                            method.name(),</span>
<span class="fc" id="L191">                            PServiceCallType.class.getName(),</span>
                            type)
<span class="fc" id="L193">                  .appendln();</span>

<span class="fc bfc" id="L195" title="All 2 branches covered.">            if (method.getResponseClass() != null) {</span>
<span class="fc" id="L196">                writer.format(&quot;%s resp = &quot;, PServiceCall.class.getName());</span>
            }

<span class="fc" id="L199">            writer.format(&quot;handler.handleCall(call, %s.kDescriptor);&quot;, service.className());</span>

<span class="fc bfc" id="L201" title="All 2 branches covered.">            if (method.getResponseClass() != null) {</span>
<span class="fc" id="L202">                writer.newline()</span>
<span class="fc" id="L203">                      .formatln(&quot;if (resp.getType() == %s.%s) {&quot;, PServiceCallType.class.getName(), PServiceCallType.EXCEPTION.name())</span>
<span class="fc" id="L204">                      .formatln(&quot;    throw (%s) resp.getMessage();&quot;,</span>
<span class="fc" id="L205">                                PApplicationException.class.getName())</span>
<span class="fc" id="L206">                      .appendln('}')</span>
<span class="fc" id="L207">                      .newline()</span>
<span class="fc" id="L208">                      .formatln(&quot;%s msg = (%s) resp.getMessage();&quot;,</span>
<span class="fc" id="L209">                                service.getResponseClassRef(method),</span>
<span class="fc" id="L210">                                service.getResponseClassRef(method));</span>

<span class="fc" id="L212">                writer.appendln(&quot;if (msg.unionField() != null) {&quot;)</span>
<span class="fc" id="L213">                      .begin()</span>
<span class="fc" id="L214">                      .appendln(&quot;switch (msg.unionField()) {&quot;)</span>
<span class="fc" id="L215">                      .begin();</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">                if (method.exceptions().length &gt; 0) {</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">                    for (JField ex : method.exceptions()) {</span>
<span class="fc" id="L218">                        writer.formatln(&quot;case %s:&quot;, ex.fieldEnum())</span>
<span class="fc" id="L219">                              .formatln(&quot;    throw msg.%s();&quot;, ex.getter());</span>
                    }
                }
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">                if (method.getResponse() != null) {</span>
<span class="fc" id="L223">                    writer.formatln(&quot;case %s:&quot;, method.getResponse().fieldEnum());</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">                    if (method.getResponse().isVoid()) {</span>
<span class="fc" id="L225">                        writer.formatln(&quot;    return;&quot;);</span>
                    } else {
<span class="fc" id="L227">                        writer.formatln(&quot;    return msg.%s();&quot;, method.getResponse().getter());</span>
                    }
                }

<span class="fc" id="L231">                writer.end()</span>
<span class="fc" id="L232">                      .appendln(&quot;}&quot;)</span>
<span class="fc" id="L233">                      .end()</span>
<span class="fc" id="L234">                      .appendln(&quot;}&quot;)</span>
<span class="fc" id="L235">                      .newline();</span>

                // In case there is no return value, and no exception,
                // the union field is not set. This *should* cause an error.
<span class="fc" id="L239">                writer.formatln(&quot;throw new %s(\&quot;Result field for %s.%s() not set\&quot;,&quot;,</span>
<span class="fc" id="L240">                                PApplicationException.class.getName(),</span>
<span class="fc" id="L241">                                service.getService().getQualifiedName(),</span>
<span class="fc" id="L242">                                method.name())</span>
<span class="fc" id="L243">                      .formatln(&quot;          %s %s.%s);&quot;,</span>
<span class="fc" id="L244">                                PApplicationException.class.getName().replaceAll(&quot;.&quot;, &quot; &quot;),</span>
<span class="fc" id="L245">                                PApplicationExceptionType.class.getName(),</span>
<span class="fc" id="L246">                                PApplicationExceptionType.MISSING_RESULT.name());</span>
            }

<span class="fc" id="L249">            writer.end()</span>
<span class="fc" id="L250">                  .appendln('}');</span>
        }

<span class="fc" id="L253">        writer.end()</span>
<span class="fc" id="L254">              .appendln('}')</span>
<span class="fc" id="L255">              .newline();</span>
<span class="fc" id="L256">    }</span>

    private void appendProcessor(IndentedPrintWriter writer, JService service) throws GeneratorException {
<span class="fc" id="L259">        writer.formatln(&quot;public static class Processor implements %s {&quot;, PProcessor.class.getName())</span>
<span class="fc" id="L260">              .begin()</span>
<span class="fc" id="L261">              .appendln(&quot;private final Iface impl;&quot;);</span>

<span class="fc" id="L263">        writer.formatln(&quot;public Processor(Iface impl) {&quot;)</span>
<span class="fc" id="L264">              .appendln(&quot;    this.impl = impl;&quot;)</span>
<span class="fc" id="L265">              .appendln('}')</span>
<span class="fc" id="L266">              .newline();</span>

<span class="fc" id="L268">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L269">              .formatln(&quot;public %s getDescriptor() {&quot;, PService.class.getName())</span>
<span class="fc" id="L270">              .appendln(&quot;    return kDescriptor;&quot;)</span>
<span class="fc" id="L271">              .appendln('}')</span>
<span class="fc" id="L272">              .newline();</span>

<span class="fc" id="L274">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L275">              .formatln(&quot;public &lt;Request extends %s&lt;Request, RequestField&gt;,&quot;, PMessage.class.getName())</span>
<span class="fc" id="L276">              .formatln(&quot;        Response extends %s&lt;Response, ResponseField&gt;,&quot;, PMessage.class.getName())</span>
<span class="fc" id="L277">              .formatln(&quot;        RequestField extends %s,&quot;, PField.class.getName())</span>
<span class="fc" id="L278">              .formatln(&quot;        ResponseField extends %s&gt;&quot;, PField.class.getName())</span>
<span class="fc" id="L279">              .formatln(&quot;%s&lt;Response, ResponseField&gt; handleCall(&quot;, PServiceCall.class.getName())</span>
<span class="fc" id="L280">              .formatln(&quot;        %s&lt;Request, RequestField&gt; call,&quot;, PServiceCall.class.getName())</span>
<span class="fc" id="L281">              .formatln(&quot;        %s service)&quot;, PService.class.getName())</span>
<span class="fc" id="L282">              .formatln(&quot;        throws %s,&quot;, IOException.class.getName())</span>
<span class="fc" id="L283">              .formatln(&quot;               %s {&quot;, SerializerException.class.getName())</span>
<span class="fc" id="L284">              .begin();</span>

<span class="fc" id="L286">        writer.appendln(&quot;switch(call.getMethod()) {&quot;)</span>
<span class="fc" id="L287">              .begin();</span>

<span class="fc bfc" id="L289" title="All 2 branches covered.">        for (JServiceMethod method : service.methods()) {</span>
<span class="fc" id="L290">            writer.formatln(&quot;case \&quot;%s\&quot;: {&quot;, method.name())</span>
<span class="fc" id="L291">                  .begin();</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">            if (method.getResponseClass() != null) {</span>
<span class="fc" id="L293">                writer.formatln(&quot;%s._Builder rsp = %s.builder();&quot;,</span>
<span class="fc" id="L294">                                service.getResponseClassRef(method),</span>
<span class="fc" id="L295">                                service.getResponseClassRef(method));</span>
            }
<span class="fc" id="L297">            String methodThrows = service.methodsThrows(method);</span>

<span class="fc bfc" id="L299" title="All 4 branches covered.">            if (methodThrows != null || method.exceptions().length &gt; 0) {</span>
<span class="fc" id="L300">                writer.appendln(&quot;try {&quot;)</span>
<span class="fc" id="L301">                      .begin();</span>
            }

<span class="fc" id="L304">            writer.formatln(&quot;%s req = (%s) call.getMessage();&quot;,</span>
<span class="fc" id="L305">                            service.getRequestClassRef(method),</span>
<span class="fc" id="L306">                            service.getRequestClassRef(method));</span>

<span class="fc" id="L308">            String indent = &quot;      &quot; + Strings.times(&quot; &quot;, method.methodName().length());</span>
<span class="fc bfc" id="L309" title="All 4 branches covered.">            if (method.getResponse() != null &amp;&amp; !method.getResponse().isVoid()) {</span>
<span class="fc" id="L310">                writer.formatln(&quot;%s result =&quot;, method.getResponse().valueType());</span>
<span class="fc" id="L311">                writer.appendln(&quot;        &quot;);</span>
<span class="fc" id="L312">                indent += &quot;        &quot;;</span>
            } else {
<span class="fc" id="L314">                writer.appendln();</span>
            }

<span class="fc" id="L317">            writer.format(&quot;impl.%s(&quot;, method.methodName())</span>
<span class="fc" id="L318">                  .begin(indent);</span>

<span class="fc" id="L320">            boolean first = true;</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L323">                    first = false;</span>
                } else {
<span class="fc" id="L325">                    writer.append(',')</span>
<span class="fc" id="L326">                          .appendln();</span>
                }
<span class="fc" id="L328">                writer.format(&quot;req.%s()&quot;, param.getter());</span>
            }
<span class="fc" id="L330">            writer.end()</span>
<span class="fc" id="L331">                  .append(&quot;);&quot;);</span>

<span class="fc bfc" id="L333" title="All 2 branches covered.">            if (method.getResponse() != null) {</span>
<span class="fc bfc" id="L334" title="All 2 branches covered.">                if (method.getResponse().isVoid()) {</span>
<span class="fc" id="L335">                    writer.formatln(&quot;rsp.%s();&quot;, method.getResponse().setter());</span>
                } else {
<span class="fc" id="L337">                    writer.formatln(&quot;rsp.%s(result);&quot;, method.getResponse().setter());</span>
                }
            }

<span class="fc bfc" id="L341" title="All 4 branches covered.">            if (methodThrows != null || method.exceptions().length &gt; 0) {</span>
<span class="fc" id="L342">                writer.end();</span>
<span class="fc bfc" id="L343" title="All 2 branches covered.">                for (JField ex : method.exceptions()) {</span>
<span class="fc" id="L344">                    writer.formatln(&quot;} catch (%s e) {&quot;, ex.instanceType())</span>
<span class="fc" id="L345">                          .formatln(&quot;    rsp.%s(e);&quot;, ex.setter());</span>
                }
<span class="fc bfc" id="L347" title="All 2 branches covered.">                if (methodThrows != null) {</span>
<span class="fc" id="L348">                    writer.formatln(&quot;} catch (%s e) {&quot;, methodThrows)</span>
<span class="fc" id="L349">                          .formatln(&quot;    throw new %s(e.getMessage(), e);&quot;, IOException.class.getName());</span>
                }
<span class="fc" id="L351">                writer.appendln('}');</span>
            }

<span class="fc bfc" id="L354" title="All 2 branches covered.">            if (method.getResponseClass() != null) {</span>
<span class="fc" id="L355">                String spaces = PServiceCall.class.getName().replaceAll(&quot;[\\S]&quot;, &quot; &quot;);</span>
<span class="fc" id="L356">                writer.formatln(&quot;%s reply =&quot;, PServiceCall.class.getName())</span>
<span class="fc" id="L357">                      .formatln(&quot;        new %s&lt;&gt;(call.getMethod(),&quot;,</span>
<span class="fc" id="L358">                                PServiceCall.class.getName())</span>
<span class="fc" id="L359">                      .formatln(&quot;            %s   %s.%s,&quot;,</span>
                                spaces,
<span class="fc" id="L361">                                PServiceCallType.class.getName(),</span>
<span class="fc" id="L362">                                PServiceCallType.REPLY.name())</span>
<span class="fc" id="L363">                      .formatln(&quot;            %s   call.getSequence(),&quot;,</span>
                                spaces)
<span class="fc" id="L365">                      .formatln(&quot;            %s   rsp.build());&quot;,</span>
                                spaces)
<span class="fc" id="L367">                      .appendln(&quot;return reply;&quot;);</span>
<span class="fc" id="L368">            } else {</span>
                // No reply, but it's fine.
<span class="fc" id="L370">                writer.appendln(&quot;return null;&quot;);</span>
            }

<span class="fc" id="L373">            writer.end()</span>
<span class="fc" id="L374">                  .appendln('}');</span>
        }

<span class="fc" id="L377">        writer.appendln(&quot;default: {&quot;)</span>
<span class="fc" id="L378">              .begin()</span>
<span class="fc" id="L379">              .formatln(&quot;%s ex =&quot;, PApplicationException.class.getName())</span>
<span class="fc" id="L380">              .formatln(&quot;        new %s(&quot;, PApplicationException.class.getName())</span>
<span class="fc" id="L381">              .formatln(&quot;                \&quot;Unknown method \\\&quot;\&quot; + call.getMethod() + \&quot;\\\&quot; on %s.\&quot;,&quot;,</span>
<span class="fc" id="L382">                        service.getService().getQualifiedName())</span>
<span class="fc" id="L383">              .formatln(&quot;                %s.%s);&quot;,</span>
<span class="fc" id="L384">                        PApplicationExceptionType.class.getName(),</span>
<span class="fc" id="L385">                        PApplicationExceptionType.UNKNOWN_METHOD.getName());</span>

<span class="fc" id="L387">        String spaces = PServiceCall.class.getName().replaceAll(&quot;[\\S]&quot;, &quot; &quot;);</span>
<span class="fc" id="L388">        writer.formatln(&quot;%s reply =&quot;, PServiceCall.class.getName())</span>
<span class="fc" id="L389">              .formatln(&quot;        new %s(call.getMethod(),&quot;,</span>
<span class="fc" id="L390">                        PServiceCall.class.getName())</span>
<span class="fc" id="L391">              .formatln(&quot;            %s %s.%s,&quot;,</span>
                        spaces,
<span class="fc" id="L393">                        PServiceCallType.class.getName(),</span>
<span class="fc" id="L394">                        PServiceCallType.EXCEPTION.name())</span>
<span class="fc" id="L395">              .formatln(&quot;            %s call.getSequence(),&quot;,</span>
                        spaces)
<span class="fc" id="L397">              .formatln(&quot;            %s ex);&quot;,</span>
                        spaces)
<span class="fc" id="L399">              .appendln(&quot;return reply;&quot;);</span>

<span class="fc" id="L401">        writer.end()</span>
<span class="fc" id="L402">              .appendln('}')</span>
<span class="fc" id="L403">              .end()</span>
<span class="fc" id="L404">              .appendln('}');</span>

<span class="fc" id="L406">        writer.end()</span>
<span class="fc" id="L407">              .appendln('}');</span>

<span class="fc" id="L409">        writer.end()</span>
<span class="fc" id="L410">              .appendln('}')</span>
<span class="fc" id="L411">              .newline();</span>
<span class="fc" id="L412">    }</span>

    private void appendDescriptor(IndentedPrintWriter writer, JService service) throws GeneratorException {
<span class="fc" id="L415">        writer.formatln(&quot;public enum Method implements %s {&quot;, PServiceMethod.class.getName())</span>
<span class="fc" id="L416">              .begin();</span>

<span class="fc bfc" id="L418" title="All 2 branches covered.">        for (JServiceMethod method : service.methods()) {</span>
<span class="fc bfc" id="L419" title="All 2 branches covered.">            String responseDesc = method.getResponseClass() == null</span>
                                  ? &quot;null&quot;
<span class="fc" id="L421">                                  : service.getResponseClassRef(method) + &quot;.kDescriptor&quot;;</span>

<span class="fc" id="L423">            writer.formatln(&quot;%s(\&quot;%s\&quot;, %b, %s.kDescriptor, %s),&quot;,</span>
<span class="fc" id="L424">                            method.constant(),</span>
<span class="fc" id="L425">                            method.name(),</span>
<span class="fc" id="L426">                            method.getMethod().isOneway(),</span>
<span class="fc" id="L427">                            service.getRequestClassRef(method),</span>
                            responseDesc);
        }

<span class="fc" id="L431">        writer.appendln(';')</span>
<span class="fc" id="L432">              .newline();</span>

<span class="fc" id="L434">        writer.appendln(&quot;private final String name;&quot;)</span>
<span class="fc" id="L435">              .appendln(&quot;private final boolean oneway;&quot;)</span>
<span class="fc" id="L436">              .formatln(&quot;private final %s request;&quot;, PStructDescriptor.class.getName())</span>
<span class="fc" id="L437">              .formatln(&quot;private final %s response;&quot;, PUnionDescriptor.class.getName())</span>
<span class="fc" id="L438">              .newline();</span>

<span class="fc" id="L440">        writer.formatln(&quot;private Method(String name, boolean oneway, %s request, %s response) {&quot;,</span>
<span class="fc" id="L441">                        PStructDescriptor.class.getName(), PUnionDescriptor.class.getName())</span>
<span class="fc" id="L442">              .appendln(&quot;    this.name = name;&quot;)</span>
<span class="fc" id="L443">              .appendln(&quot;    this.oneway = oneway;&quot;)</span>
<span class="fc" id="L444">              .appendln(&quot;    this.request = request;&quot;)</span>
<span class="fc" id="L445">              .appendln(&quot;    this.response = response;&quot;)</span>
<span class="fc" id="L446">              .appendln('}')</span>
<span class="fc" id="L447">              .newline();</span>

<span class="fc" id="L449">        writer.appendln(&quot;public String getName() {&quot;)</span>
<span class="fc" id="L450">              .appendln(&quot;    return name;&quot;)</span>
<span class="fc" id="L451">              .appendln('}')</span>
<span class="fc" id="L452">              .newline()</span>
<span class="fc" id="L453">              .appendln(&quot;public boolean isOneway() {&quot;)</span>
<span class="fc" id="L454">              .appendln(&quot;    return oneway;&quot;)</span>
<span class="fc" id="L455">              .appendln('}')</span>
<span class="fc" id="L456">              .newline()</span>
<span class="fc" id="L457">              .formatln(&quot;public %s getRequestType() {&quot;,</span>
<span class="fc" id="L458">                        PStructDescriptor.class.getName())</span>
<span class="fc" id="L459">              .formatln(&quot;    return request;&quot;)</span>
<span class="fc" id="L460">              .appendln('}')</span>
<span class="fc" id="L461">              .newline()</span>
<span class="fc" id="L462">              .formatln(&quot;public %s getResponseType() {&quot;,</span>
<span class="fc" id="L463">                        PUnionDescriptor.class.getName())</span>
<span class="fc" id="L464">              .formatln(&quot;    return response;&quot;)</span>
<span class="fc" id="L465">              .appendln('}')</span>
<span class="fc" id="L466">              .newline();</span>

<span class="fc" id="L468">        writer.appendln(&quot;public static Method forName(String name) {&quot;)</span>
<span class="fc" id="L469">              .begin()</span>
<span class="fc" id="L470">              .appendln(&quot;switch (name) {&quot;)</span>
<span class="fc" id="L471">              .begin();</span>

<span class="fc bfc" id="L473" title="All 2 branches covered.">        for (JServiceMethod method : service.methods()) {</span>
<span class="fc" id="L474">            writer.formatln(&quot;case \&quot;%s\&quot;: return %s;&quot;,</span>
<span class="fc" id="L475">                            method.name(), method.constant());</span>
        }

<span class="fc" id="L478">        writer.end()</span>
<span class="fc" id="L479">              .appendln('}')</span>
<span class="fc" id="L480">              .appendln(&quot;return null;&quot;)</span>
<span class="fc" id="L481">              .end()</span>
<span class="fc" id="L482">              .appendln('}');</span>

<span class="fc" id="L484">        writer.end()</span>
<span class="fc" id="L485">              .appendln('}')</span>
<span class="fc" id="L486">              .newline();</span>

<span class="fc" id="L488">        String inherits = &quot;null&quot;;</span>
<span class="fc bfc" id="L489" title="All 2 branches covered.">        if (service.getService().getExtendsService() != null) {</span>
<span class="fc" id="L490">            CService other = service.getService().getExtendsService();</span>
<span class="fc" id="L491">            inherits = helper.getJavaPackage(other) + &quot;.&quot; +</span>
<span class="fc" id="L492">                       new JService(other, helper).className() + &quot;.provider()&quot;;</span>
        }

<span class="fc" id="L495">        writer.formatln(&quot;private static class _Descriptor extends %s {&quot;,</span>
<span class="fc" id="L496">                        PService.class.getName())</span>
<span class="fc" id="L497">              .begin()</span>
<span class="fc" id="L498">              .appendln(&quot;private _Descriptor() {&quot;)</span>
<span class="fc" id="L499">              .formatln(&quot;    super(\&quot;%s\&quot;, \&quot;%s\&quot;, %s, Method.values());&quot;,</span>
<span class="fc" id="L500">                        service.getService().getProgramName(),</span>
<span class="fc" id="L501">                        service.getService().getName(),</span>
                        inherits)
<span class="fc" id="L503">              .appendln('}')</span>
<span class="fc" id="L504">              .newline()</span>
<span class="fc" id="L505">              .appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L506">              .appendln(&quot;public Method getMethod(String name) {&quot;)</span>
<span class="fc" id="L507">              .appendln(&quot;    return Method.forName(name);&quot;)</span>
<span class="fc" id="L508">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L509">              .end()</span>
<span class="fc" id="L510">              .appendln('}')</span>
<span class="fc" id="L511">              .newline();</span>

<span class="fc" id="L513">        writer.formatln(&quot;private static class _Provider implements %s {&quot;,</span>
<span class="fc" id="L514">                        PServiceProvider.class.getName())</span>
<span class="fc" id="L515">              .begin()</span>
<span class="fc" id="L516">              .appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L517">              .formatln(&quot;public %s getService() {&quot;, PService.class.getName())</span>
<span class="fc" id="L518">              .appendln(&quot;    return kDescriptor;&quot;)</span>
<span class="fc" id="L519">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L520">              .end()</span>
<span class="fc" id="L521">              .appendln('}')</span>
<span class="fc" id="L522">              .newline();</span>

<span class="fc" id="L524">        writer.formatln(&quot;public static final %s kDescriptor = new _Descriptor();&quot;,</span>
<span class="fc" id="L525">                        PService.class.getName())</span>
<span class="fc" id="L526">              .newline();</span>

<span class="fc" id="L528">        writer.formatln(&quot;public static %s provider() {&quot;,</span>
<span class="fc" id="L529">                        PServiceProvider.class.getName())</span>
<span class="fc" id="L530">              .appendln(&quot;    return new _Provider();&quot;)</span>
<span class="fc" id="L531">              .appendln('}')</span>
<span class="fc" id="L532">              .newline();</span>
<span class="fc" id="L533">    }</span>

    private void appendStructs(IndentedPrintWriter writer, JService service) throws GeneratorException, IOException {
<span class="fc bfc" id="L536" title="All 2 branches covered.">        for (JServiceMethod method : service.declaredMethods()) {</span>
<span class="fc" id="L537">            JMessage request = new JMessage&lt;&gt;(method.getMethod().getRequestType(), helper);</span>
<span class="fc" id="L538">            writer.formatln(&quot;// type --&gt; %s&quot;, request.descriptor().getName());</span>

<span class="fc" id="L540">            messageFormat.appendMessageClass(method.getMethod().getRequestType());</span>

<span class="fc bfc" id="L542" title="All 2 branches covered.">            if (method.getMethod().getResponseType() != null) {</span>
<span class="fc" id="L543">                JMessage response = new JMessage&lt;&gt;(method.getMethod().getResponseType(), helper);</span>
<span class="fc" id="L544">                writer.formatln(&quot;// type &lt;-- %s&quot;, response.descriptor().getName());</span>

<span class="fc" id="L546">                messageFormat.appendMessageClass(method.getMethod().getResponseType());</span>
            }
        }
<span class="fc" id="L549">    }</span>

    private void appendIface(IndentedPrintWriter writer, JService service) throws GeneratorException {
<span class="fc" id="L552">        String inherits = &quot;&quot;;</span>
<span class="fc bfc" id="L553" title="All 2 branches covered.">        if (service.getService().getExtendsService() != null) {</span>
<span class="fc" id="L554">            CService other = service.getService().getExtendsService();</span>
<span class="fc" id="L555">            inherits = &quot;extends &quot; + helper.getJavaPackage(other) + &quot;.&quot; +</span>
<span class="fc" id="L556">                       new JService(other, helper).className() + &quot;.Iface &quot;;</span>
        }

<span class="fc bfc" id="L559" title="All 2 branches covered.">        if (service.getService().getDocumentation() != null) {</span>
<span class="fc" id="L560">            new BlockCommentBuilder(writer)</span>
<span class="fc" id="L561">                    .comment(service.getService().getDocumentation())</span>
<span class="fc" id="L562">                    .finish();</span>
        }

<span class="fc" id="L565">        writer.formatln(&quot;public interface Iface %s{&quot;, inherits)</span>
<span class="fc" id="L566">              .begin();</span>

<span class="fc" id="L568">        boolean firstMethod = true;</span>
<span class="fc bfc" id="L569" title="All 2 branches covered.">        for (JServiceMethod method : service.declaredMethods()) {</span>
<span class="fc bfc" id="L570" title="All 2 branches covered.">            if (firstMethod) {</span>
<span class="fc" id="L571">                firstMethod = false;</span>
            } else {
<span class="fc" id="L573">                writer.newline();</span>
            }
<span class="fc" id="L575">            String methodThrows = service.methodsThrows(method);</span>

<span class="fc" id="L577">            BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>

<span class="fc bfc" id="L579" title="All 2 branches covered.">            if (method.getMethod().getDocumentation() != null) {</span>
<span class="fc" id="L580">                comment.comment(method.getMethod().getDocumentation())</span>
<span class="fc" id="L581">                       .newline();</span>
            }

<span class="fc bfc" id="L584" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="pc bpc" id="L585" title="1 of 2 branches missed.">                if (param.comment() != null) {</span>
<span class="nc" id="L586">                    comment.param_(param.param(), param.comment());</span>
                } else {
<span class="fc" id="L588">                    comment.param_(param.param(), &quot;The &quot; + param.name() + &quot; value.&quot;);</span>
                }
            }

<span class="fc bfc" id="L592" title="All 2 branches covered.">            if (method.getResponse() != null &amp;&amp;</span>
<span class="fc bfc" id="L593" title="All 2 branches covered.">                    !method.getResponse().isVoid()) {</span>
<span class="fc" id="L594">                comment.return_(&quot;The &quot; + method.name() + &quot; result.&quot;);</span>
            }

<span class="fc bfc" id="L597" title="All 2 branches covered.">            if (methodThrows != null) {</span>
<span class="fc" id="L598">                comment.throws_(methodThrows, &quot;On any declared exception.&quot;);</span>
            } else {
<span class="fc bfc" id="L600" title="All 2 branches covered.">                for (JField param : method.exceptions()) {</span>
<span class="pc bpc" id="L601" title="1 of 2 branches missed.">                    if (param.comment() != null) {</span>
<span class="nc" id="L602">                        comment.throws_(param.fieldType(), param.comment());</span>
                    } else {
<span class="fc" id="L604">                        comment.throws_(param.fieldType(), &quot;The &quot; + param.name() + &quot; exception.&quot;);</span>
                    }
                }
            }
<span class="fc" id="L608">            comment.throws_(IOException.class, &quot;On providence or non-declared exceptions.&quot;)</span>
<span class="fc" id="L609">                   .finish();</span>

<span class="fc" id="L611">            JField ret = method.getResponse();</span>
<span class="fc bfc" id="L612" title="All 2 branches covered.">            if (ret != null) {</span>
<span class="fc" id="L613">                writer.appendln(ret.valueType());</span>
            } else {
<span class="fc" id="L615">                writer.appendln(&quot;void&quot;);</span>
            }

<span class="fc" id="L618">            writer.format(&quot; %s(&quot;, method.methodName())</span>
<span class="fc" id="L619">                  .begin(&quot;        &quot;);</span>

<span class="fc" id="L621">            boolean first = true;</span>
<span class="fc bfc" id="L622" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="fc bfc" id="L623" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L624">                    first = false;</span>
                } else {
<span class="fc" id="L626">                    writer.append(&quot;,&quot;);</span>
                }
<span class="fc" id="L628">                writer.formatln(&quot;%s %s&quot;, param.valueType(), param.param());</span>
            }

<span class="fc" id="L631">            writer.end()</span>
<span class="fc" id="L632">                  .format(&quot;)&quot;);</span>
<span class="fc" id="L633">            writer.formatln(&quot;        throws %s&quot;, IOException.class.getName())</span>
<span class="fc" id="L634">                  .begin(&quot;               &quot;);</span>
<span class="fc bfc" id="L635" title="All 2 branches covered.">            if (methodThrows != null) {</span>
<span class="fc" id="L636">                writer.append(&quot;,&quot;);</span>
<span class="fc" id="L637">                writer.formatln(&quot;%s&quot;, methodThrows);</span>
            } else {
<span class="fc bfc" id="L639" title="All 2 branches covered.">                for (JField ex : method.exceptions()) {</span>
<span class="fc" id="L640">                    writer.append(&quot;,&quot;);</span>
<span class="fc" id="L641">                    writer.appendln(ex.instanceType());</span>
                }
            }
<span class="fc" id="L644">            writer.format(&quot;;&quot;)</span>
<span class="fc" id="L645">                  .end();</span>
        }

<span class="fc" id="L648">        writer.end()</span>
<span class="fc" id="L649">              .appendln('}')</span>
<span class="fc" id="L650">              .newline();</span>
<span class="fc" id="L651">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>