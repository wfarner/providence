<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JavaServiceFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Providence Generator : Java</a> &gt; <a href="index.source.html" class="el_package">net.morimekta.providence.generator.format.java</a> &gt; <span class="el_source">JavaServiceFormatter.java</span></div><h1>JavaServiceFormatter.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016 Providence Authors
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package net.morimekta.providence.generator.format.java;

import net.morimekta.providence.PApplicationException;
import net.morimekta.providence.PApplicationExceptionType;
import net.morimekta.providence.PClient;
import net.morimekta.providence.PMessage;
import net.morimekta.providence.PProcessor;
import net.morimekta.providence.PServiceCall;
import net.morimekta.providence.PServiceCallHandler;
import net.morimekta.providence.PServiceCallType;
import net.morimekta.providence.descriptor.PField;
import net.morimekta.providence.descriptor.PService;
import net.morimekta.providence.descriptor.PServiceMethod;
import net.morimekta.providence.descriptor.PServiceProvider;
import net.morimekta.providence.descriptor.PStructDescriptor;
import net.morimekta.providence.descriptor.PUnionDescriptor;
import net.morimekta.providence.generator.GeneratorException;
import net.morimekta.providence.generator.format.java.shared.BaseServiceFormatter;
import net.morimekta.providence.generator.format.java.utils.BlockCommentBuilder;
import net.morimekta.providence.generator.format.java.utils.JField;
import net.morimekta.providence.generator.format.java.utils.JHelper;
import net.morimekta.providence.generator.format.java.utils.JMessage;
import net.morimekta.providence.generator.format.java.utils.JService;
import net.morimekta.providence.generator.format.java.utils.JServiceMethod;
import net.morimekta.providence.reflect.contained.CService;
import net.morimekta.providence.serializer.SerializerException;
import net.morimekta.util.Strings;
import net.morimekta.util.io.IndentedPrintWriter;

import javax.annotation.Generated;
import java.io.IOException;
import java.io.UncheckedIOException;
import java.util.Properties;

public class JavaServiceFormatter implements BaseServiceFormatter {
    private final JHelper              helper;
    private final JavaMessageFormatter messageFormat;
    private final IndentedPrintWriter  writer;
    private final JavaOptions          options;
    private final String               version;

    JavaServiceFormatter(IndentedPrintWriter writer,
                         JHelper helper,
                         JavaMessageFormatter messageFormat,
<span class="fc" id="L65">                         JavaOptions options) {</span>
<span class="fc" id="L66">        this.writer = writer;</span>
<span class="fc" id="L67">        this.helper = helper;</span>
<span class="fc" id="L68">        this.messageFormat = messageFormat;</span>
<span class="fc" id="L69">        this.options = options;</span>

        try {
<span class="fc" id="L72">            Properties properties = new Properties();</span>
<span class="fc" id="L73">            properties.load(getClass().getResourceAsStream(&quot;/java_generator_version.properties&quot;));</span>

<span class="fc" id="L75">            this.version = properties.getProperty(&quot;java_generator_version&quot;);</span>
<span class="nc" id="L76">        } catch (IOException e) {</span>
<span class="nc" id="L77">            throw new UncheckedIOException(e);</span>
<span class="fc" id="L78">        }</span>

<span class="fc" id="L80">    }</span>

    @Override
    public void appendServiceClass(CService cs) throws GeneratorException, IOException {
<span class="fc" id="L84">        JService service = new JService(cs, helper);</span>

<span class="fc bfc" id="L86" title="All 2 branches covered.">        if (cs.getDocumentation() != null) {</span>
<span class="fc" id="L87">            new BlockCommentBuilder(writer)</span>
<span class="fc" id="L88">                    .comment(cs.getDocumentation())</span>
<span class="fc" id="L89">                    .finish();</span>
        }

<span class="fc" id="L92">        String inherits = &quot;&quot;;</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (service.getService().getExtendsService() != null) {</span>
<span class="fc" id="L94">            CService other = service.getService().getExtendsService();</span>
<span class="fc" id="L95">            inherits = &quot;extends &quot; + helper.getJavaPackage(other) + &quot;.&quot; +</span>
<span class="fc" id="L96">                       new JService(other, helper).className() + &quot; &quot;;</span>
        }

<span class="fc" id="L99">        writer.appendln(&quot;@SuppressWarnings(\&quot;unused\&quot;)&quot;);</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">        if (options.generated_annotation) {</span>
<span class="nc" id="L101">            writer.formatln(&quot;@%s(\&quot;providence java generator %s\&quot;)&quot;, Generated.class.getName(), version);</span>
        }

<span class="fc" id="L104">        writer.formatln(&quot;public class %s %s{&quot;, service.className(), inherits)</span>
<span class="fc" id="L105">              .begin();</span>

<span class="fc" id="L107">        appendIface(writer, service);</span>

<span class="fc" id="L109">        appendClient(writer, service);</span>

<span class="fc" id="L111">        appendProcessor(writer, service);</span>

<span class="fc" id="L113">        appendDescriptor(writer, service);</span>

<span class="fc" id="L115">        appendStructs(writer, service);</span>

        // protected constructor should defeat instantiation, but can inherit
        // from parent to be able to get access to inner protected classes.
<span class="fc" id="L119">        writer.formatln(&quot;protected %s() {}&quot;, service.className());</span>

<span class="fc" id="L121">        writer.end()</span>
<span class="fc" id="L122">              .appendln('}');</span>
<span class="fc" id="L123">    }</span>

    private void appendClient(IndentedPrintWriter writer, JService service) throws GeneratorException {
<span class="fc" id="L126">        BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>
<span class="fc" id="L127">        if (service.getService()</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">                   .getDocumentation() != null) {</span>
<span class="fc" id="L129">            comment.comment(service.getService().getDocumentation())</span>
<span class="fc" id="L130">                   .newline();</span>
        }
<span class="fc" id="L132">        comment.comment(&quot;Client implementation for &quot; + service.getService().getQualifiedName())</span>
<span class="fc" id="L133">               .finish();</span>

<span class="fc" id="L135">        writer.appendln(&quot;public static class Client&quot;)</span>
<span class="fc" id="L136">              .formatln(&quot;        extends %s&quot;, PClient.class.getName())</span>
<span class="fc" id="L137">              .formatln(&quot;        implements Iface {&quot;)</span>
<span class="fc" id="L138">              .begin();</span>

<span class="fc" id="L140">        writer.formatln(&quot;private final %s handler;&quot;, PServiceCallHandler.class.getName())</span>
<span class="fc" id="L141">              .newline();</span>

<span class="fc" id="L143">        new BlockCommentBuilder(writer)</span>
<span class="fc" id="L144">                .comment(&quot;Create &quot; + service.getService().getQualifiedName() + &quot; service client.&quot;)</span>
<span class="fc" id="L145">                .newline()</span>
<span class="fc" id="L146">                .param_(&quot;handler&quot;, &quot;The client handler.&quot;)</span>
<span class="fc" id="L147">                .finish();</span>

<span class="fc" id="L149">        writer.formatln(&quot;public Client(%s handler) {&quot;, PServiceCallHandler.class.getName())</span>
<span class="fc" id="L150">              .appendln(&quot;    this.handler = handler;&quot;)</span>
<span class="fc" id="L151">              .appendln('}')</span>
<span class="fc" id="L152">              .newline();</span>

<span class="fc" id="L154">        boolean firstMethod = true;</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        for (JServiceMethod method : service.methods()) {</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">            if (firstMethod) {</span>
<span class="fc" id="L157">                firstMethod = false;</span>
            } else {
<span class="fc" id="L159">                writer.newline();</span>
            }

<span class="fc" id="L162">            writer.appendln(&quot;@Override&quot;);</span>

            // Field ID 0 is the return type.
<span class="fc" id="L165">            JField ret = method.getResponse();</span>

<span class="fc" id="L167">            writer.appendln(&quot;public &quot;);</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            if (ret != null) {</span>
<span class="fc" id="L169">                writer.append(ret.valueType());</span>
            } else {
<span class="fc" id="L171">                writer.append(&quot;void&quot;);</span>
            }

<span class="fc" id="L174">            writer.format(&quot; %s(&quot;, method.methodName())</span>
<span class="fc" id="L175">                  .begin(&quot;        &quot;);</span>

<span class="fc" id="L177">            boolean first = true;</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L180">                    first = false;</span>
                } else {
<span class="fc" id="L182">                    writer.append(&quot;,&quot;);</span>
                }
<span class="fc" id="L184">                writer.formatln(&quot;%s %s&quot;, param.valueType(), param.param());</span>
            }

<span class="fc" id="L187">            writer.end()</span>
<span class="fc" id="L188">                  .format(&quot;)&quot;)</span>
<span class="fc" id="L189">                  .formatln(&quot;        throws %s&quot;, IOException.class.getName())</span>
<span class="fc" id="L190">                  .begin(   &quot;               &quot;);</span>

<span class="fc bfc" id="L192" title="All 2 branches covered.">            for (JField ex : method.exceptions()) {</span>
<span class="fc" id="L193">                writer.append(&quot;,&quot;);</span>
<span class="fc" id="L194">                writer.appendln(ex.instanceType());</span>
            }

<span class="fc" id="L197">            writer.format(&quot; {&quot;)</span>
<span class="fc" id="L198">                  .end()</span>
<span class="fc" id="L199">                  .begin();</span>

<span class="fc" id="L201">            writer.formatln(&quot;%s._Builder rq = %s.builder();&quot;,</span>
<span class="fc" id="L202">                            service.getRequestClassRef(method),</span>
<span class="fc" id="L203">                            service.getRequestClassRef(method));</span>

<span class="fc bfc" id="L205" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="fc" id="L206">                writer.formatln(&quot;rq.%s(%s);&quot;, param.setter(), param.param());</span>
            }

<span class="fc bfc" id="L209" title="All 2 branches covered.">            String type = method.getMethod().isOneway()</span>
<span class="fc" id="L210">                          ? PServiceCallType.ONEWAY.name()</span>
<span class="fc" id="L211">                          : PServiceCallType.CALL.name();</span>
<span class="fc" id="L212">            writer.newline()</span>
<span class="fc" id="L213">                  .formatln(&quot;%s call = new %s&lt;&gt;(\&quot;%s\&quot;, %s.%s, getNextSequenceId(), rq.build());&quot;,</span>
<span class="fc" id="L214">                            PServiceCall.class.getName(),</span>
<span class="fc" id="L215">                            PServiceCall.class.getName(),</span>
<span class="fc" id="L216">                            method.name(),</span>
<span class="fc" id="L217">                            PServiceCallType.class.getName(),</span>
                            type)
<span class="fc" id="L219">                  .appendln();</span>

<span class="fc bfc" id="L221" title="All 2 branches covered.">            if (method.getResponseClass() != null) {</span>
<span class="fc" id="L222">                writer.format(&quot;%s resp = &quot;, PServiceCall.class.getName());</span>
            }

<span class="fc" id="L225">            writer.format(&quot;handler.handleCall(call, %s.kDescriptor);&quot;, service.className());</span>

<span class="fc bfc" id="L227" title="All 2 branches covered.">            if (method.getResponseClass() != null) {</span>
<span class="fc" id="L228">                writer.newline()</span>
<span class="fc" id="L229">                      .formatln(&quot;if (resp.getType() == %s.%s) {&quot;, PServiceCallType.class.getName(), PServiceCallType.EXCEPTION.name())</span>
<span class="fc" id="L230">                      .formatln(&quot;    throw (%s) resp.getMessage();&quot;,</span>
<span class="fc" id="L231">                                PApplicationException.class.getName())</span>
<span class="fc" id="L232">                      .appendln('}')</span>
<span class="fc" id="L233">                      .newline()</span>
<span class="fc" id="L234">                      .formatln(&quot;%s msg = (%s) resp.getMessage();&quot;,</span>
<span class="fc" id="L235">                                service.getResponseClassRef(method),</span>
<span class="fc" id="L236">                                service.getResponseClassRef(method));</span>

<span class="fc" id="L238">                writer.appendln(&quot;if (msg.unionField() != null) {&quot;)</span>
<span class="fc" id="L239">                      .begin()</span>
<span class="fc" id="L240">                      .appendln(&quot;switch (msg.unionField()) {&quot;)</span>
<span class="fc" id="L241">                      .begin();</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">                if (method.exceptions().length &gt; 0) {</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">                    for (JField ex : method.exceptions()) {</span>
<span class="fc" id="L244">                        writer.formatln(&quot;case %s:&quot;, ex.fieldEnum())</span>
<span class="fc" id="L245">                              .formatln(&quot;    throw msg.%s();&quot;, ex.getter());</span>
                    }
                }
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">                if (method.getResponse() != null) {</span>
<span class="fc" id="L249">                    writer.formatln(&quot;case %s:&quot;, method.getResponse().fieldEnum());</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">                    if (method.getResponse().isVoid()) {</span>
<span class="fc" id="L251">                        writer.formatln(&quot;    return;&quot;);</span>
                    } else {
<span class="fc" id="L253">                        writer.formatln(&quot;    return msg.%s();&quot;, method.getResponse().getter());</span>
                    }
                }

<span class="fc" id="L257">                writer.end()</span>
<span class="fc" id="L258">                      .appendln(&quot;}&quot;)</span>
<span class="fc" id="L259">                      .end()</span>
<span class="fc" id="L260">                      .appendln(&quot;}&quot;)</span>
<span class="fc" id="L261">                      .newline();</span>

                // In case there is no return value, and no exception,
                // the union field is not set. This *should* cause an error.
<span class="fc" id="L265">                writer.formatln(&quot;throw new %s(\&quot;Result field for %s.%s() not set\&quot;,&quot;,</span>
<span class="fc" id="L266">                                PApplicationException.class.getName(),</span>
<span class="fc" id="L267">                                service.getService().getQualifiedName(),</span>
<span class="fc" id="L268">                                method.name())</span>
<span class="fc" id="L269">                      .formatln(&quot;          %s %s.%s);&quot;,</span>
<span class="fc" id="L270">                                PApplicationException.class.getName().replaceAll(&quot;.&quot;, &quot; &quot;),</span>
<span class="fc" id="L271">                                PApplicationExceptionType.class.getName(),</span>
<span class="fc" id="L272">                                PApplicationExceptionType.MISSING_RESULT.name());</span>
            }

<span class="fc" id="L275">            writer.end()</span>
<span class="fc" id="L276">                  .appendln('}');</span>
        }

<span class="fc" id="L279">        writer.end()</span>
<span class="fc" id="L280">              .appendln('}')</span>
<span class="fc" id="L281">              .newline();</span>
<span class="fc" id="L282">    }</span>

    private void appendProcessor(IndentedPrintWriter writer, JService service) throws GeneratorException {
<span class="fc" id="L285">        writer.formatln(&quot;public static class Processor implements %s {&quot;, PProcessor.class.getName())</span>
<span class="fc" id="L286">              .begin()</span>
<span class="fc" id="L287">              .appendln(&quot;private final Iface impl;&quot;);</span>

<span class="fc" id="L289">        writer.formatln(&quot;public Processor(Iface impl) {&quot;)</span>
<span class="fc" id="L290">              .appendln(&quot;    this.impl = impl;&quot;)</span>
<span class="fc" id="L291">              .appendln('}')</span>
<span class="fc" id="L292">              .newline();</span>

<span class="fc" id="L294">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L295">              .formatln(&quot;public %s getDescriptor() {&quot;, PService.class.getName())</span>
<span class="fc" id="L296">              .appendln(&quot;    return kDescriptor;&quot;)</span>
<span class="fc" id="L297">              .appendln('}')</span>
<span class="fc" id="L298">              .newline();</span>

<span class="fc" id="L300">        writer.appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L301">              .formatln(&quot;public &lt;Request extends %s&lt;Request, RequestField&gt;,&quot;, PMessage.class.getName())</span>
<span class="fc" id="L302">              .formatln(&quot;        Response extends %s&lt;Response, ResponseField&gt;,&quot;, PMessage.class.getName())</span>
<span class="fc" id="L303">              .formatln(&quot;        RequestField extends %s,&quot;, PField.class.getName())</span>
<span class="fc" id="L304">              .formatln(&quot;        ResponseField extends %s&gt;&quot;, PField.class.getName())</span>
<span class="fc" id="L305">              .formatln(&quot;%s&lt;Response, ResponseField&gt; handleCall(&quot;, PServiceCall.class.getName())</span>
<span class="fc" id="L306">              .formatln(&quot;        %s&lt;Request, RequestField&gt; call,&quot;, PServiceCall.class.getName())</span>
<span class="fc" id="L307">              .formatln(&quot;        %s service)&quot;, PService.class.getName())</span>
<span class="fc" id="L308">              .formatln(&quot;        throws %s,&quot;, IOException.class.getName())</span>
<span class="fc" id="L309">              .formatln(&quot;               %s {&quot;, SerializerException.class.getName())</span>
<span class="fc" id="L310">              .begin();</span>

<span class="fc" id="L312">        writer.appendln(&quot;switch(call.getMethod()) {&quot;)</span>
<span class="fc" id="L313">              .begin();</span>

<span class="fc bfc" id="L315" title="All 2 branches covered.">        for (JServiceMethod method : service.methods()) {</span>
<span class="fc" id="L316">            writer.formatln(&quot;case \&quot;%s\&quot;: {&quot;, method.name())</span>
<span class="fc" id="L317">                  .begin();</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">            if (method.getResponseClass() != null) {</span>
<span class="fc" id="L319">                writer.formatln(&quot;%s._Builder rsp = %s.builder();&quot;,</span>
<span class="fc" id="L320">                                service.getResponseClassRef(method),</span>
<span class="fc" id="L321">                                service.getResponseClassRef(method));</span>
            }
<span class="fc" id="L323">            String methodThrows = service.methodsThrows(method);</span>

<span class="fc bfc" id="L325" title="All 4 branches covered.">            if (methodThrows != null || method.exceptions().length &gt; 0) {</span>
<span class="fc" id="L326">                writer.appendln(&quot;try {&quot;)</span>
<span class="fc" id="L327">                      .begin();</span>
            }

<span class="fc" id="L330">            writer.formatln(&quot;%s req = (%s) call.getMessage();&quot;,</span>
<span class="fc" id="L331">                            service.getRequestClassRef(method),</span>
<span class="fc" id="L332">                            service.getRequestClassRef(method));</span>

<span class="fc" id="L334">            String indent = &quot;      &quot; + Strings.times(&quot; &quot;, method.methodName().length());</span>
<span class="fc bfc" id="L335" title="All 4 branches covered.">            if (method.getResponse() != null &amp;&amp; !method.getResponse().isVoid()) {</span>
<span class="fc" id="L336">                writer.formatln(&quot;%s result =&quot;, method.getResponse().valueType());</span>
<span class="fc" id="L337">                writer.appendln(&quot;        &quot;);</span>
<span class="fc" id="L338">                indent += &quot;        &quot;;</span>
            } else {
<span class="fc" id="L340">                writer.appendln();</span>
            }

<span class="fc" id="L343">            writer.format(&quot;impl.%s(&quot;, method.methodName())</span>
<span class="fc" id="L344">                  .begin(indent);</span>

<span class="fc" id="L346">            boolean first = true;</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L349">                    first = false;</span>
                } else {
<span class="fc" id="L351">                    writer.append(',')</span>
<span class="fc" id="L352">                          .appendln();</span>
                }
<span class="fc" id="L354">                writer.format(&quot;req.%s()&quot;, param.getter());</span>
            }
<span class="fc" id="L356">            writer.end()</span>
<span class="fc" id="L357">                  .append(&quot;);&quot;);</span>

<span class="fc bfc" id="L359" title="All 2 branches covered.">            if (method.getResponse() != null) {</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">                if (method.getResponse().isVoid()) {</span>
<span class="fc" id="L361">                    writer.formatln(&quot;rsp.%s();&quot;, method.getResponse().setter());</span>
                } else {
<span class="fc" id="L363">                    writer.formatln(&quot;rsp.%s(result);&quot;, method.getResponse().setter());</span>
                }
            }

<span class="fc bfc" id="L367" title="All 4 branches covered.">            if (methodThrows != null || method.exceptions().length &gt; 0) {</span>
<span class="fc" id="L368">                writer.end();</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">                for (JField ex : method.exceptions()) {</span>
<span class="fc" id="L370">                    writer.formatln(&quot;} catch (%s e) {&quot;, ex.instanceType())</span>
<span class="fc" id="L371">                          .formatln(&quot;    rsp.%s(e);&quot;, ex.setter());</span>
                }
<span class="fc bfc" id="L373" title="All 2 branches covered.">                if (methodThrows != null) {</span>
<span class="fc" id="L374">                    writer.formatln(&quot;} catch (%s e) {&quot;, methodThrows)</span>
<span class="fc" id="L375">                          .formatln(&quot;    throw new %s(e.getMessage(), e);&quot;, IOException.class.getName());</span>
                }
<span class="fc" id="L377">                writer.appendln('}');</span>
            }

<span class="fc bfc" id="L380" title="All 2 branches covered.">            if (method.getResponseClass() != null) {</span>
<span class="fc" id="L381">                String spaces = PServiceCall.class.getName().replaceAll(&quot;[\\S]&quot;, &quot; &quot;);</span>
<span class="fc" id="L382">                writer.formatln(&quot;%s reply =&quot;, PServiceCall.class.getName())</span>
<span class="fc" id="L383">                      .formatln(&quot;        new %s&lt;&gt;(call.getMethod(),&quot;,</span>
<span class="fc" id="L384">                                PServiceCall.class.getName())</span>
<span class="fc" id="L385">                      .formatln(&quot;            %s   %s.%s,&quot;,</span>
                                spaces,
<span class="fc" id="L387">                                PServiceCallType.class.getName(),</span>
<span class="fc" id="L388">                                PServiceCallType.REPLY.name())</span>
<span class="fc" id="L389">                      .formatln(&quot;            %s   call.getSequence(),&quot;,</span>
                                spaces)
<span class="fc" id="L391">                      .formatln(&quot;            %s   rsp.build());&quot;,</span>
                                spaces)
<span class="fc" id="L393">                      .appendln(&quot;return reply;&quot;);</span>
<span class="fc" id="L394">            } else {</span>
                // No reply, but it's fine.
<span class="fc" id="L396">                writer.appendln(&quot;return null;&quot;);</span>
            }

<span class="fc" id="L399">            writer.end()</span>
<span class="fc" id="L400">                  .appendln('}');</span>
        }

<span class="fc" id="L403">        writer.appendln(&quot;default: {&quot;)</span>
<span class="fc" id="L404">              .begin()</span>
<span class="fc" id="L405">              .formatln(&quot;%s ex =&quot;, PApplicationException.class.getName())</span>
<span class="fc" id="L406">              .formatln(&quot;        new %s(&quot;, PApplicationException.class.getName())</span>
<span class="fc" id="L407">              .formatln(&quot;                \&quot;Unknown method \\\&quot;\&quot; + call.getMethod() + \&quot;\\\&quot; on %s.\&quot;,&quot;,</span>
<span class="fc" id="L408">                        service.getService().getQualifiedName())</span>
<span class="fc" id="L409">              .formatln(&quot;                %s.%s);&quot;,</span>
<span class="fc" id="L410">                        PApplicationExceptionType.class.getName(),</span>
<span class="fc" id="L411">                        PApplicationExceptionType.UNKNOWN_METHOD.getName());</span>

<span class="fc" id="L413">        String spaces = PServiceCall.class.getName().replaceAll(&quot;[\\S]&quot;, &quot; &quot;);</span>
<span class="fc" id="L414">        writer.formatln(&quot;%s reply =&quot;, PServiceCall.class.getName())</span>
<span class="fc" id="L415">              .formatln(&quot;        new %s(call.getMethod(),&quot;,</span>
<span class="fc" id="L416">                        PServiceCall.class.getName())</span>
<span class="fc" id="L417">              .formatln(&quot;            %s %s.%s,&quot;,</span>
                        spaces,
<span class="fc" id="L419">                        PServiceCallType.class.getName(),</span>
<span class="fc" id="L420">                        PServiceCallType.EXCEPTION.name())</span>
<span class="fc" id="L421">              .formatln(&quot;            %s call.getSequence(),&quot;,</span>
                        spaces)
<span class="fc" id="L423">              .formatln(&quot;            %s ex);&quot;,</span>
                        spaces)
<span class="fc" id="L425">              .appendln(&quot;return reply;&quot;);</span>

<span class="fc" id="L427">        writer.end()</span>
<span class="fc" id="L428">              .appendln('}')</span>
<span class="fc" id="L429">              .end()</span>
<span class="fc" id="L430">              .appendln('}');</span>

<span class="fc" id="L432">        writer.end()</span>
<span class="fc" id="L433">              .appendln('}');</span>

<span class="fc" id="L435">        writer.end()</span>
<span class="fc" id="L436">              .appendln('}')</span>
<span class="fc" id="L437">              .newline();</span>
<span class="fc" id="L438">    }</span>

    private void appendDescriptor(IndentedPrintWriter writer, JService service) throws GeneratorException {
<span class="fc" id="L441">        writer.formatln(&quot;public enum Method implements %s {&quot;, PServiceMethod.class.getName())</span>
<span class="fc" id="L442">              .begin();</span>

<span class="fc bfc" id="L444" title="All 2 branches covered.">        for (JServiceMethod method : service.methods()) {</span>
<span class="fc bfc" id="L445" title="All 2 branches covered.">            String responseDesc = method.getResponseClass() == null</span>
                                  ? &quot;null&quot;
<span class="fc" id="L447">                                  : service.getResponseClassRef(method) + &quot;.kDescriptor&quot;;</span>

<span class="fc" id="L449">            writer.formatln(&quot;%s(\&quot;%s\&quot;, %b, %s.kDescriptor, %s),&quot;,</span>
<span class="fc" id="L450">                            method.constant(),</span>
<span class="fc" id="L451">                            method.name(),</span>
<span class="fc" id="L452">                            method.getMethod().isOneway(),</span>
<span class="fc" id="L453">                            service.getRequestClassRef(method),</span>
                            responseDesc);
        }

<span class="fc" id="L457">        writer.appendln(';')</span>
<span class="fc" id="L458">              .newline();</span>

<span class="fc" id="L460">        writer.appendln(&quot;private final String name;&quot;)</span>
<span class="fc" id="L461">              .appendln(&quot;private final boolean oneway;&quot;)</span>
<span class="fc" id="L462">              .formatln(&quot;private final %s request;&quot;, PStructDescriptor.class.getName())</span>
<span class="fc" id="L463">              .formatln(&quot;private final %s response;&quot;, PUnionDescriptor.class.getName())</span>
<span class="fc" id="L464">              .newline();</span>

<span class="fc" id="L466">        writer.formatln(&quot;private Method(String name, boolean oneway, %s request, %s response) {&quot;,</span>
<span class="fc" id="L467">                        PStructDescriptor.class.getName(), PUnionDescriptor.class.getName())</span>
<span class="fc" id="L468">              .appendln(&quot;    this.name = name;&quot;)</span>
<span class="fc" id="L469">              .appendln(&quot;    this.oneway = oneway;&quot;)</span>
<span class="fc" id="L470">              .appendln(&quot;    this.request = request;&quot;)</span>
<span class="fc" id="L471">              .appendln(&quot;    this.response = response;&quot;)</span>
<span class="fc" id="L472">              .appendln('}')</span>
<span class="fc" id="L473">              .newline();</span>

<span class="fc" id="L475">        writer.appendln(&quot;public String getName() {&quot;)</span>
<span class="fc" id="L476">              .appendln(&quot;    return name;&quot;)</span>
<span class="fc" id="L477">              .appendln('}')</span>
<span class="fc" id="L478">              .newline()</span>
<span class="fc" id="L479">              .appendln(&quot;public boolean isOneway() {&quot;)</span>
<span class="fc" id="L480">              .appendln(&quot;    return oneway;&quot;)</span>
<span class="fc" id="L481">              .appendln('}')</span>
<span class="fc" id="L482">              .newline()</span>
<span class="fc" id="L483">              .formatln(&quot;public %s getRequestType() {&quot;,</span>
<span class="fc" id="L484">                        PStructDescriptor.class.getName())</span>
<span class="fc" id="L485">              .formatln(&quot;    return request;&quot;)</span>
<span class="fc" id="L486">              .appendln('}')</span>
<span class="fc" id="L487">              .newline()</span>
<span class="fc" id="L488">              .formatln(&quot;public %s getResponseType() {&quot;,</span>
<span class="fc" id="L489">                        PUnionDescriptor.class.getName())</span>
<span class="fc" id="L490">              .formatln(&quot;    return response;&quot;)</span>
<span class="fc" id="L491">              .appendln('}')</span>
<span class="fc" id="L492">              .newline();</span>

<span class="fc" id="L494">        writer.appendln(&quot;public static Method forName(String name) {&quot;)</span>
<span class="fc" id="L495">              .begin()</span>
<span class="fc" id="L496">              .appendln(&quot;switch (name) {&quot;)</span>
<span class="fc" id="L497">              .begin();</span>

<span class="fc bfc" id="L499" title="All 2 branches covered.">        for (JServiceMethod method : service.methods()) {</span>
<span class="fc" id="L500">            writer.formatln(&quot;case \&quot;%s\&quot;: return %s;&quot;,</span>
<span class="fc" id="L501">                            method.name(), method.constant());</span>
        }

<span class="fc" id="L504">        writer.end()</span>
<span class="fc" id="L505">              .appendln('}')</span>
<span class="fc" id="L506">              .appendln(&quot;return null;&quot;)</span>
<span class="fc" id="L507">              .end()</span>
<span class="fc" id="L508">              .appendln('}');</span>

<span class="fc" id="L510">        writer.end()</span>
<span class="fc" id="L511">              .appendln('}')</span>
<span class="fc" id="L512">              .newline();</span>

<span class="fc" id="L514">        String inherits = &quot;null&quot;;</span>
<span class="fc bfc" id="L515" title="All 2 branches covered.">        if (service.getService().getExtendsService() != null) {</span>
<span class="fc" id="L516">            CService other = service.getService().getExtendsService();</span>
<span class="fc" id="L517">            inherits = helper.getJavaPackage(other) + &quot;.&quot; +</span>
<span class="fc" id="L518">                       new JService(other, helper).className() + &quot;.provider()&quot;;</span>
        }

<span class="fc" id="L521">        writer.formatln(&quot;private static class _Descriptor extends %s {&quot;,</span>
<span class="fc" id="L522">                        PService.class.getName())</span>
<span class="fc" id="L523">              .begin()</span>
<span class="fc" id="L524">              .appendln(&quot;private _Descriptor() {&quot;)</span>
<span class="fc" id="L525">              .formatln(&quot;    super(\&quot;%s\&quot;, \&quot;%s\&quot;, %s, Method.values());&quot;,</span>
<span class="fc" id="L526">                        service.getService().getProgramName(),</span>
<span class="fc" id="L527">                        service.getService().getName(),</span>
                        inherits)
<span class="fc" id="L529">              .appendln('}')</span>
<span class="fc" id="L530">              .newline()</span>
<span class="fc" id="L531">              .appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L532">              .appendln(&quot;public Method getMethod(String name) {&quot;)</span>
<span class="fc" id="L533">              .appendln(&quot;    return Method.forName(name);&quot;)</span>
<span class="fc" id="L534">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L535">              .end()</span>
<span class="fc" id="L536">              .appendln('}')</span>
<span class="fc" id="L537">              .newline();</span>

<span class="fc" id="L539">        writer.formatln(&quot;private static class _Provider implements %s {&quot;,</span>
<span class="fc" id="L540">                        PServiceProvider.class.getName())</span>
<span class="fc" id="L541">              .begin()</span>
<span class="fc" id="L542">              .appendln(&quot;@Override&quot;)</span>
<span class="fc" id="L543">              .formatln(&quot;public %s getService() {&quot;, PService.class.getName())</span>
<span class="fc" id="L544">              .appendln(&quot;    return kDescriptor;&quot;)</span>
<span class="fc" id="L545">              .appendln(&quot;}&quot;)</span>
<span class="fc" id="L546">              .end()</span>
<span class="fc" id="L547">              .appendln('}')</span>
<span class="fc" id="L548">              .newline();</span>

<span class="fc" id="L550">        writer.formatln(&quot;public static final %s kDescriptor = new _Descriptor();&quot;,</span>
<span class="fc" id="L551">                        PService.class.getName())</span>
<span class="fc" id="L552">              .newline();</span>

<span class="fc" id="L554">        writer.formatln(&quot;public static %s provider() {&quot;,</span>
<span class="fc" id="L555">                        PServiceProvider.class.getName())</span>
<span class="fc" id="L556">              .appendln(&quot;    return new _Provider();&quot;)</span>
<span class="fc" id="L557">              .appendln('}')</span>
<span class="fc" id="L558">              .newline();</span>
<span class="fc" id="L559">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    private void appendStructs(IndentedPrintWriter writer, JService service) throws GeneratorException, IOException {
<span class="fc bfc" id="L563" title="All 2 branches covered.">        for (JServiceMethod method : service.declaredMethods()) {</span>
<span class="fc" id="L564">            JMessage request = new JMessage&lt;&gt;(method.getMethod().getRequestType(), helper);</span>
<span class="fc" id="L565">            writer.formatln(&quot;// type --&gt; %s&quot;, request.descriptor().getName());</span>

<span class="fc" id="L567">            messageFormat.appendMessageClass(method.getMethod().getRequestType());</span>

<span class="fc bfc" id="L569" title="All 2 branches covered.">            if (method.getMethod().getResponseType() != null) {</span>
<span class="fc" id="L570">                JMessage response = new JMessage(method.getMethod().getResponseType(), helper);</span>
<span class="fc" id="L571">                writer.formatln(&quot;// type &lt;-- %s&quot;, response.descriptor().getName());</span>

<span class="fc" id="L573">                messageFormat.appendMessageClass(method.getMethod().getResponseType());</span>
            }
        }
<span class="fc" id="L576">    }</span>

    private void appendIface(IndentedPrintWriter writer, JService service) throws GeneratorException {
<span class="fc" id="L579">        String inherits = &quot;&quot;;</span>
<span class="fc bfc" id="L580" title="All 2 branches covered.">        if (service.getService().getExtendsService() != null) {</span>
<span class="fc" id="L581">            CService other = service.getService().getExtendsService();</span>
<span class="fc" id="L582">            inherits = &quot;extends &quot; + helper.getJavaPackage(other) + &quot;.&quot; +</span>
<span class="fc" id="L583">                       new JService(other, helper).className() + &quot;.Iface &quot;;</span>
        }

<span class="fc bfc" id="L586" title="All 2 branches covered.">        if (service.getService().getDocumentation() != null) {</span>
<span class="fc" id="L587">            new BlockCommentBuilder(writer)</span>
<span class="fc" id="L588">                    .comment(service.getService().getDocumentation())</span>
<span class="fc" id="L589">                    .finish();</span>
        }

<span class="fc" id="L592">        writer.formatln(&quot;public interface Iface %s{&quot;, inherits)</span>
<span class="fc" id="L593">              .begin();</span>

<span class="fc" id="L595">        boolean firstMethod = true;</span>
<span class="fc bfc" id="L596" title="All 2 branches covered.">        for (JServiceMethod method : service.declaredMethods()) {</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">            if (firstMethod) {</span>
<span class="fc" id="L598">                firstMethod = false;</span>
            } else {
<span class="fc" id="L600">                writer.newline();</span>
            }
<span class="fc" id="L602">            String methodThrows = service.methodsThrows(method);</span>

<span class="fc" id="L604">            BlockCommentBuilder comment = new BlockCommentBuilder(writer);</span>

<span class="fc bfc" id="L606" title="All 2 branches covered.">            if (method.getMethod().getDocumentation() != null) {</span>
<span class="fc" id="L607">                comment.comment(method.getMethod().getDocumentation())</span>
<span class="fc" id="L608">                       .newline();</span>
            }

<span class="fc bfc" id="L611" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">                if (param.comment() != null) {</span>
<span class="nc" id="L613">                    comment.param_(param.param(), param.comment());</span>
                } else {
<span class="fc" id="L615">                    comment.param_(param.param(), &quot;The &quot; + param.name() + &quot; value.&quot;);</span>
                }
            }

<span class="fc bfc" id="L619" title="All 2 branches covered.">            if (method.getResponse() != null &amp;&amp;</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">                    !method.getResponse().isVoid()) {</span>
<span class="fc" id="L621">                comment.return_(&quot;The &quot; + method.name() + &quot; result.&quot;);</span>
            }

<span class="fc bfc" id="L624" title="All 2 branches covered.">            if (methodThrows != null) {</span>
<span class="fc" id="L625">                comment.throws_(methodThrows, &quot;On any declared exception.&quot;);</span>
            } else {
<span class="fc bfc" id="L627" title="All 2 branches covered.">                for (JField param : method.exceptions()) {</span>
<span class="pc bpc" id="L628" title="1 of 2 branches missed.">                    if (param.comment() != null) {</span>
<span class="nc" id="L629">                        comment.throws_(param.fieldType(), param.comment());</span>
                    } else {
<span class="fc" id="L631">                        comment.throws_(param.fieldType(), &quot;The &quot; + param.name() + &quot; exception.&quot;);</span>
                    }
                }
            }
<span class="fc" id="L635">            comment.throws_(IOException.class, &quot;On providence or non-declared exceptions.&quot;)</span>
<span class="fc" id="L636">                   .finish();</span>

<span class="fc" id="L638">            JField ret = method.getResponse();</span>
<span class="fc bfc" id="L639" title="All 2 branches covered.">            if (ret != null) {</span>
<span class="fc" id="L640">                writer.appendln(ret.valueType());</span>
            } else {
<span class="fc" id="L642">                writer.appendln(&quot;void&quot;);</span>
            }

<span class="fc" id="L645">            writer.format(&quot; %s(&quot;, method.methodName())</span>
<span class="fc" id="L646">                  .begin(&quot;        &quot;);</span>

<span class="fc" id="L648">            boolean first = true;</span>
<span class="fc bfc" id="L649" title="All 2 branches covered.">            for (JField param : method.params()) {</span>
<span class="fc bfc" id="L650" title="All 2 branches covered.">                if (first) {</span>
<span class="fc" id="L651">                    first = false;</span>
                } else {
<span class="fc" id="L653">                    writer.append(&quot;,&quot;);</span>
                }
<span class="fc" id="L655">                writer.formatln(&quot;%s %s&quot;, param.valueType(), param.param());</span>
            }

<span class="fc" id="L658">            writer.end()</span>
<span class="fc" id="L659">                  .format(&quot;)&quot;);</span>
<span class="fc" id="L660">            writer.formatln(&quot;        throws %s&quot;, IOException.class.getName())</span>
<span class="fc" id="L661">                  .begin(&quot;               &quot;);</span>
<span class="fc bfc" id="L662" title="All 2 branches covered.">            if (methodThrows != null) {</span>
<span class="fc" id="L663">                writer.append(&quot;,&quot;);</span>
<span class="fc" id="L664">                writer.formatln(&quot;%s&quot;, methodThrows);</span>
            } else {
<span class="fc bfc" id="L666" title="All 2 branches covered.">                for (JField ex : method.exceptions()) {</span>
<span class="fc" id="L667">                    writer.append(&quot;,&quot;);</span>
<span class="fc" id="L668">                    writer.appendln(ex.instanceType());</span>
                }
            }
<span class="fc" id="L671">            writer.format(&quot;;&quot;)</span>
<span class="fc" id="L672">                  .end();</span>
        }

<span class="fc" id="L675">        writer.end()</span>
<span class="fc" id="L676">              .appendln('}')</span>
<span class="fc" id="L677">              .newline();</span>
<span class="fc" id="L678">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>