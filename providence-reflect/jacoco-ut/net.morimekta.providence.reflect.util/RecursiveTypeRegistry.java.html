<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecursiveTypeRegistry.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Providence Utils : Reflection</a> &gt; <a href="index.source.html" class="el_package">net.morimekta.providence.reflect.util</a> &gt; <span class="el_source">RecursiveTypeRegistry.java</span></div><h1>RecursiveTypeRegistry.java</h1><pre class="source lang-java linenums">package net.morimekta.providence.reflect.util;

import net.morimekta.providence.descriptor.PDeclaredDescriptor;
import net.morimekta.providence.descriptor.PService;
import net.morimekta.providence.util.BaseTypeRegistry;

import javax.annotation.Nonnull;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;

/**
 * A registry that can reference each other recursively. Each registry will
 * have a specific package context, and needs to be built up in a recursive
 * manner. This way each type registry will only have access to the described
 * types actually referenced and included in the given thrift program file.
 */
public class RecursiveTypeRegistry extends BaseTypeRegistry {
    private final String                              localProgramContext;
    private final Map&lt;String, PDeclaredDescriptor&lt;?&gt;&gt; declaredTypes;
    private final Map&lt;String, PService&gt;               services;
    private final Map&lt;String, RecursiveTypeRegistry&gt;  includes;

<span class="fc" id="L24">    public RecursiveTypeRegistry(@Nonnull String localProgramContext) {</span>
<span class="fc" id="L25">        this.localProgramContext = localProgramContext;</span>
<span class="fc" id="L26">        this.declaredTypes       = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L27">        this.services            = new HashMap&lt;&gt;();</span>
<span class="fc" id="L28">        this.includes            = new HashMap&lt;&gt;();</span>
<span class="fc" id="L29">    }</span>

    public String getLocalProgramContext() {
<span class="nc" id="L32">        return localProgramContext;</span>
    }

    /**
     * Get the registry to be used for the specific program. Search through
     * all the included registries to find the best one.
     *
     * @param programName The program to find registry for.
     * @return The Recursive type registry or null of not found.
     */
    public RecursiveTypeRegistry getRegistryForProgramName(String programName) {
<span class="nc bnc" id="L43" title="All 2 branches missed.">        if (localProgramContext.equals(programName)) return this;</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">        for (RecursiveTypeRegistry registry : includes.values()) {</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">            if (registry.getLocalProgramContext().equals(programName)) {</span>
<span class="nc" id="L46">                return registry;</span>
            }
<span class="nc" id="L48">        }</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">        for (RecursiveTypeRegistry registry : includes.values()) {</span>
<span class="nc" id="L50">            RecursiveTypeRegistry tmp = registry.getRegistryForProgramName(programName);</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">            if (tmp != null) {</span>
<span class="nc" id="L52">                return tmp;</span>
            }
<span class="nc" id="L54">        }</span>
<span class="nc" id="L55">        return null;</span>
    }

    /**
     * Register a recursive included registry.
     *
     * @param programName The program to be included.
     * @param registry The registry for the given program.
     */
    public void registerInclude(String programName, RecursiveTypeRegistry registry) {
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (includes.containsKey(programName)) {</span>
<span class="nc" id="L66">            return;</span>
        }
<span class="nc" id="L68">        includes.put(programName, registry);</span>
<span class="nc" id="L69">    }</span>

    @Nonnull
    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T extends PDeclaredDescriptor&lt;T&gt;&gt; T getDeclaredType(@Nonnull String typeName,
                                                                @Nonnull String programContext) {
<span class="fc" id="L76">        String finalName = finalTypename(typeName, programContext);</span>

<span class="fc" id="L78">        String program = finalName.replaceAll(&quot;\\..*&quot;, &quot;&quot;);</span>
<span class="fc" id="L79">        String name = finalName.replaceAll(&quot;.*\\.&quot;, &quot;&quot;);</span>

<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (declaredTypes.containsKey(name)) {</span>
<span class="fc" id="L82">            return (T) declaredTypes.get(name);</span>
        }
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (localProgramContext.equals(program)) {</span>
<span class="nc" id="L85">            throw new IllegalArgumentException(</span>
                    &quot;No such type \&quot;&quot; + name + &quot;\&quot; in program \&quot;&quot; + program + &quot;\&quot;&quot;);
        }
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (includes.containsKey(program)) {</span>
<span class="nc" id="L89">            return includes.get(program).getDeclaredType(name, program);</span>
        }
<span class="nc" id="L91">        throw new IllegalArgumentException(</span>
                &quot;No such program \&quot;&quot; + program + &quot;\&quot; known for type \&quot;&quot; + typeName + &quot;\&quot;&quot;);
    }

    @Nonnull
    @Override
    public PService getService(String serviceName, String programContext) {
<span class="nc" id="L98">        String finalName = qualifiedNameFromIdAndContext(serviceName, programContext);</span>

<span class="nc" id="L100">        String program = finalName.replaceAll(&quot;\\..*&quot;, &quot;&quot;);</span>
<span class="nc" id="L101">        String name = finalName.replaceAll(&quot;.*\\.&quot;, &quot;&quot;);</span>

<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (services.containsKey(name)) {</span>
<span class="nc" id="L104">            return services.get(name);</span>
        }
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (localProgramContext.equals(program)) {</span>
<span class="nc" id="L107">            throw new IllegalArgumentException(&quot;No such service \&quot;&quot; + name + &quot;\&quot; in program \&quot;&quot; + program + &quot;\&quot;&quot;);</span>
        }
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (services.containsKey(finalName)) {</span>
<span class="nc" id="L110">            return services.get(finalName);</span>
        }
<span class="nc" id="L112">        throw new IllegalArgumentException(&quot;No such program \&quot;&quot; + program + &quot;\&quot; known for service \&quot;&quot; + serviceName + &quot;\&quot;&quot;);</span>
    }

    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    public boolean register(@Nonnull PService service) {
<span class="nc" id="L118">        String program = service.getProgramName();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (!localProgramContext.equals(program)) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (!includes.containsKey(program)) {</span>
<span class="nc" id="L122">                includes.get(program).registerRecursively(service);</span>
            }
<span class="nc" id="L124">            throw new IllegalArgumentException(&quot;&quot;);</span>
        }
<span class="nc" id="L126">        String serviceName = service.getName();</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (services.containsKey(serviceName)) {</span>
<span class="nc" id="L129">            return false;</span>
        }
<span class="nc" id="L131">        services.put(serviceName, service);</span>
<span class="nc" id="L132">        return true;</span>
    }

    @Override
    public &lt;T&gt; boolean register(PDeclaredDescriptor&lt;T&gt; declaredType) {
<span class="fc" id="L137">        String program = declaredType.getProgramName();</span>

<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if (!localProgramContext.equals(program)) {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (includes.containsKey(program)) {</span>
<span class="nc" id="L141">                includes.get(program).registerRecursively(declaredType);</span>
            }
<span class="nc" id="L143">            throw new IllegalArgumentException(&quot;&quot;);</span>
        }
<span class="fc" id="L145">        String typeName = declaredType.getName();</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (declaredTypes.containsKey(typeName)) {</span>
<span class="nc" id="L147">            return false;</span>
        }

<span class="fc" id="L150">        declaredTypes.put(typeName, declaredType);</span>
<span class="fc" id="L151">        return true;</span>
    }

    protected boolean isEmpty() {
<span class="pc bpc" id="L155" title="3 of 4 branches missed.">        return declaredTypes.isEmpty() &amp;&amp; services.isEmpty();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>